<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Cloud Custodian Architecture, Deployment and Policy Preprocessing - Jason Antman's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.jasonantman.com/2017/10/cloud-custodian-architecture-deployment-and-policy-preprocessing/">

        <meta name="author" content="Jason Antman" />
        <meta name="keywords" content="aws,cloud-custodian,cloud custodian,c7n,lambda,sqs,splunk" />
        <meta name="description" content="Details of how I setup Capital One’s Cloud Custodain at work, including our monitoring, logging and policy preprocessing." />

        <meta property="og:site_name" content="Jason Antman's Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Cloud Custodian Architecture, Deployment and Policy Preprocessing"/>
        <meta property="og:url" content="https://blog.jasonantman.com/2017/10/cloud-custodian-architecture-deployment-and-policy-preprocessing/"/>
        <meta property="og:description" content="Details of how I setup Capital One’s Cloud Custodain at work, including our monitoring, logging and policy preprocessing."/>
        <meta property="article:published_time" content="2017-10-24" />
            <meta property="article:section" content="AWS" />
            <meta property="article:tag" content="aws" />
            <meta property="article:tag" content="cloud-custodian" />
            <meta property="article:tag" content="cloud custodian" />
            <meta property="article:tag" content="c7n" />
            <meta property="article:tag" content="lambda" />
            <meta property="article:tag" content="sqs" />
            <meta property="article:tag" content="splunk" />
            <meta property="article:author" content="Jason Antman" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.jasonantman.com/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="https://blog.jasonantman.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.jasonantman.com/theme/css/pygments/default.css" rel="stylesheet">
        <link href="https://blog.jasonantman.com/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.jasonantman.com/theme/css/style.css" type="text/css"/>
        <link href="https://blog.jasonantman.com/theme/css/shariff/shariff.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://blog.jasonantman.com/theme/css/forkongithub.min.css" type="text/css" />

        <link href="https://blog.jasonantman.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog ATOM Feed"/>

        <link href="https://blog.jasonantman.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Jason Antman's Blog RSS Feed"/>


        <link href="https://blog.jasonantman.com/feeds/categories/aws.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog AWS ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
<span id="forkongithub"><a href="https://github.com/jantman/blog">Fork me on GitHub</a></span>        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.jasonantman.com/" class="navbar-brand">
Jason Antman's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/pages/about.html">About Me</a></li>
                    <li><a href="/categories/aws/index.html">AWS</a></li>
                    <li><a href="/categories/software/index.html">Software</a></li>
                    <li><a href="/categories/hardware/index.html">Hardware</a></li>
                    <li><a href="/categories/diy-home-automation-security/index.html">DIY / Home Automation / Security</a></li>
                    <li><a href="/categories/miscellaneous/index.html">Miscellaneous</a></li>
                    <li><a href="/tags.html">Tags</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://blog.jasonantman.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.jasonantman.com/2017/10/cloud-custodian-architecture-deployment-and-policy-preprocessing/"
                       rel="bookmark"
                       title="Permalink to Cloud Custodian Architecture, Deployment and Policy Preprocessing">
                        Cloud Custodian Architecture, Deployment and Policy&nbsp;Preprocessing
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-10-24T16:49:00-04:00"> Tue 24 October 2017</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://blog.jasonantman.com/tags/aws/index.html">aws</a>
        /
	<a href="https://blog.jasonantman.com/tags/cloud-custodian/index.html">cloud-custodian</a>
        /
	<a href="https://blog.jasonantman.com/tags/cloud-custodian/index.html">cloud custodian</a>
        /
	<a href="https://blog.jasonantman.com/tags/c7n/index.html">c7n</a>
        /
	<a href="https://blog.jasonantman.com/tags/lambda/index.html">lambda</a>
        /
	<a href="https://blog.jasonantman.com/tags/sqs/index.html">sqs</a>
        /
	<a href="https://blog.jasonantman.com/tags/splunk/index.html">splunk</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <div class="toc">
<ul>
<li><a href="#overall-architecture">Overall&nbsp;Architecture</a></li>
<li><a href="#test-and-deployment">Test and&nbsp;Deployment</a></li>
<li><a href="#policy-preprocessing">Policy Preprocessing</a><ul>
<li><a href="#interpolating-defaults-into-policies">Interpolating Defaults into&nbsp;Policies</a></li>
<li><a href="#policy-sanity-checks">Policy Sanity&nbsp;Checks</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#source-code">Source Code</a><ul>
<li><a href="#redefaulthtmlj2-email-template">redefault.html.j2 Email&nbsp;Template</a></li>
<li><a href="#jenkinsfile">Jenkinsfile</a></li>
<li><a href="#makefile">Makefile</a></li>
<li><a href="#policygenpy">policygen.py</a></li>
<li><a href="#test_policygenpy">test_policygen.py</a></li>
<li><a href="#errorscanpy">errorscan.py</a></li>
</ul>
</li>
</ul>
</div>
<p><em>This post was originally published to my company&#8217;s internal blog platform; I&#8217;m publishing it here for the
larger Cloud Custodian user&nbsp;community.</em></p>
<p>At work I&#8217;ve spent quite a bit of time over the past few weeks working on our deployment of Capital One&#8217;s
<a href="https://github.com/capitalone/cloud-custodian">cloud custodian</a> (a.k.a. <a href="https://pypi.python.org/pypi/c7n">c7n</a>)
for rules and policy enforcement in our <span class="caps">AWS</span> accounts, both to replace our aged
<a href="https://github.com/Netflix/SimianArmy/wiki/Janitor-Home">Netflix Janitor Monkey</a>
installation and to enable us to expand the cleanup rules we execute and begin
enforcing more granular policies. While we&#8217;ve only been running c7n for a few months
(and most of that time in a test only/dry run mode), we&#8217;ve already accumulated
29 different policies (mostly Janitor Monkey replacements for tag enforcement and low utilization instance termination)
and are adding new ones rather quickly. Based on interest from colleagues I&#8217;d like
to explain a bit about how we manage and deploy Cloud Custodian, and specifically
about how we preprocess our policies to generate the <code>custodian.yml</code> configuration.</p>
<h2 id="overall-architecture"><a class="toclink" href="#overall-architecture">Overall&nbsp;Architecture</a></h2>
<p>We currently run all of our Cloud Custodian policies as Lambda functions, taking
advantage of c7n&#8217;s excellent <a href="http://www.capitalone.io/cloud-custodian/docs/policy/lambda.html">Lambda support</a>.
Each policy currently runs on a schedule (based on CloudWatch Events); we&#8217;ve experimented
with running policies based on Config rules, Instance state changes and CloudTrail Events,
but most of those executed too quickly to prove useful for our needs (specifically tag enforcement
policies, as many of our development teams use tooling that defers tagging until significantly
after resource creation). In addition to the main Lambda functions that execute the policies,
we run a number of other ancillary tools related to Cloud&nbsp;Custodian:</p>
<ol>
<li>We use the <a href="https://github.com/capitalone/cloud-custodian/tree/master/tools/c7n_mailer">Custodian Mailer (c7n-mailer)</a>
  tool for email notifications, coupled with a customized
  <a href="#redefaulthtmlj2-email-template">email template</a> based on the <a href="https://github.com/capitalone/cloud-custodian/blob/master/tools/c7n_mailer/msg-templates/default.html.j2">example</a>
  for visually appealing and useful notifications across email clients (like the example below). This also runs as a Lambda
  function, and processes notification events that c7n policies push onto an <span class="caps">SQS</span> queue.
  <img alt="screenshot of c7n notification email template" src="/GFX/custodian-email-example.png"></li>
<li>We use Splunk as our (new) central logging solution and run a custom Lambda function, <code>sqs_splunk_lambda</code>,
  forked from <code>c7n-mailer</code> but modified to send cloud-custodian policy run results to Splunk Cloud instead of email.
  Cloud Custodian&#8217;s <a href="http://www.capitalone.io/cloud-custodian/docs/generated/c7n.html#c7n.actions.Notify">notify action</a>,
  which is used to trigger <code>c7n-mailer</code>, works by pushing some <span class="caps">JSON</span> data to an <span class="caps">SQS</span> queue; this data includes the full
  details of the policy itself, the resources that the policy matched, and why (what filter(s)) each resource was matched.
  Our policy preprocessor (see below) adds a notify action to <em>every</em> policy that sends to a specific, separate <span class="caps">SQS</span> queue
  for the Splunk function. The Lambda function processes this queue every five minutes, removes some repetitive and
  less-important data (to get the message size below <span class="caps">10KB</span>), and then sends the <span class="caps">JSON</span> message on to Splunk. This places
  the full data from every policy execution in Splunk, and allows us to search
  Splunk for high-level queries like &#8220;every <span class="caps">EC2</span> Instance that c7n stopped&#8221;, &#8220;every resource matched by a specific policy&#8221;,
  or &#8220;every action that a specific policy has&nbsp;taken&#8221;.</li>
<li>Asynchronous Lambda function executions - such as those triggered by CloudWatch Events - are automatically retried up
  to three times if the invocation fails. However, there&#8217;s no easy way to tell if all tries of a particular function
  invocation failed. <a href="#errorscanpy">errorscan.py</a>
  is our solution to this problem. We configure all of our Cloud Custodian policy Lambda functions with a Dead Letter Queue,
  a feature of Lambda that pushes a message to a <span class="caps">SQS</span> queue if all retries of an invocation failed. <code>errorscan.py</code> runs
  once a day via Jenkins and checks for messages in a single shared Dead Letter Queue (<span class="caps">DLQ</span>). If there are any, it uses CloudWatch
  Logs to associate the queue entry with the Lambda function that failed, and outputs the logs from the failed invocation(s).
  The <code>errorscan.py</code> script also examines the Failed and Throttled Invocations metrics in CloudWatch for each function.
  If there were any entries in the <span class="caps">DLQ</span> or failed/throttled invocations metrics beyond a specified threshold, the job will
  report that information and then fail, triggering a low urgency notification to our on-call&nbsp;engineer.</li>
<li>We store our policies in git, one file per policy, with common default values removed. Our <a href="#policygenpy">policygen.py</a> script,
  explained in detail below, reads the policy files, interpolates our defaults, performs some sanity checking,
  and then generates the single <code>custodian.yml</code> file actually used by&nbsp;c7n.</li>
</ol>
<h2 id="test-and-deployment"><a class="toclink" href="#test-and-deployment">Test and&nbsp;Deployment</a></h2>
<p>We test and deploy our Cloud Custodian infrastructure using a <a href="#jenkinsfile">Jenkinsfile</a>.
For simplicity of dependencies, most of the stages utilize the Jenkins <a href="https://plugins.jenkins.io/docker-workflow">Docker Workflow</a>
plugin and run inside the public <a href="https://hub.docker.com/_/python/">python:2-wheezy</a> image and the jobs that manage the
infrastructure dependencies run inside the public <a href="https://hub.docker.com/r/hashicorp/terraform/">hashicorp/terraform</a> image.
Most of the actual custodian commands are run from a <a href="#makefile">Makefile</a>, which makes it
easier to run the same commands from either the Jenkins pipeline or a local development&nbsp;environment.</p>
<p>We follow a pull request GitHub workflow, and only allow merges to the master branch from PRs that have been successfully
built by Jenkins. Our pipeline differentiates between builds of the master branch (which triggers deployment) and builds
of PRs or other branches (which are test/dry run&nbsp;only).</p>
<p>The steps in the pipeline are as&nbsp;follows:</p>
<ol>
<li><strong>Terraform</strong> - run a <code>terraform apply</code> for master, or a <code>terraform plan</code> for non-master. This uses terraform to manage the
  required infrastructure for c7n,
  namely the CloudWatch Log Group for the c7n lambda functions, the s3 bucket for the c7n output, the <span class="caps">IAM</span> Role that the
  c7n functions execute with, and the <span class="caps">SQS</span> queues for the mailer, splunk log shipper, and the dead letter&nbsp;queue.</li>
<li><strong>virtualenv</strong> - Setup a new Python virtualenv in the Docker container for the following steps, and copy the current directory
  (git clone / Jenkins workspace) to <code>/app</code> in the container. We do the latter because Jenkins runs as a normal user
  but the public Python docker container prefers to run as root (0:0). To prevent problems, we copy the Jenkins workspace
  to <code>/app</code> in the container, run what we need to, and then copy any desired output back to the workspace and <code>chown</code>
  it to Jenkins&#8217; user and group when&nbsp;finished.</li>
<li><strong>tox</strong> - Install <a href="https://tox.readthedocs.io/en/latest/">tox</a> in the virtualenv; we use this to run pytest unit tests for
  our custom code in subsequent&nbsp;steps.</li>
<li><strong>policygen tests</strong> - Run <a href="#policygenpy">unit tests for our policygen.py</a>&nbsp;script.</li>
<li><strong>sqs_splunk_lambda tests</strong> - Run unit tests for our <code>sqs_splunk_lambda</code> Splunk log shipper&nbsp;code.</li>
<li><strong>Validate</strong> - Install dependencies for c7n, generate our <code>custodian.yml</code> file using <code>policygen.py</code>, and then
  run <code>custodian validate</code> on the resulting file. This step also generates the <code>policies.rst</code> file containing a
  table of our current policy names and comments/descriptions (which we include in our internal Sphinx-built documentation),
  and copies both <code>custodian.yml</code> and <code>policies.rst</code> back to the Jenkins workspace for archiving in the job&nbsp;history.</li>
<li><strong>mugc dry run</strong> - Cloud Custodian deploys its Lambda functions via a reusable Lambda management library,
  <a href="https://github.com/capitalone/cloud-custodian/blob/master/c7n/mu.py">c7n.mu</a>, and we use its garbage collection
  tool, <a href="https://github.com/capitalone/cloud-custodian/blob/master/tools/ops/mugc.py">mugc.py</a>, to clean up the
  Lambda functions and CloudWatch Events for policies we&#8217;ve deleted. In this step, we do a dry run of the garbage
  collection&nbsp;script.</li>
<li><strong>custodian dry run</strong> - This performs a <code>custodian</code> dry run as a final check for our policies, copies the
  dry-run results/output back to the Jenkins workspace, and archives it in the job&nbsp;history.</li>
<li><strong>Run</strong> - For builds of the master branch, we do the actual <code>mugc.py</code> garbage collection of old Lambdas/Events,
  do the actual <code>custodian</code> run to provision our c7n Lambda functions, and provision the <code>c7n_mailer</code> Lambda function.
  For non-master branches, we only install the mailer&#8217;s dependencies (sanity check) and print our mailer config file
  to&nbsp;<span class="caps">STDOUT</span>.</li>
<li><strong>sqs_splunk_lambda</strong> - For builds of master, we install our <code>sqs_splunk_lambda</code> code and provision its
  Lambda function. For builds other than master, we run <code>sqs_splunk_lambda --validate</code> to validate its configuration
  file. This step is run in a <code>VaultBuildWrapper</code>, as it securely retrieves Splunk credentials from our
  <a href="https://www.vaultproject.io/">HashiCorp Vault</a>&nbsp;instance.</li>
<li><strong>Build Docs</strong> - We run a Sphinx build of our documentation, which is mostly static content but also includes the
  generated list of our policies from step&nbsp;6.</li>
<li><strong>Publish Docs</strong> - For builds of master, we push the <span class="caps">HTML</span> documentation built in the last step to the <code>gh-pages</code> branch
  for serving via GitHub&nbsp;Pages.</li>
<li><strong>Job <span class="caps">DSL</span> for Monitoring Job</strong> - For builds of master, we run
  <a href="https://jenkinsci.github.io/job-dsl-plugin/">Job <span class="caps">DSL</span></a> to create or update a persistent Jenkins job
  (outside the pipeline) that runs <code>errorscan.py</code> once a day and notifies us if any Lambda function errors were&nbsp;found.</li>
</ol>
<p>We also have shell scripts provided for testing changes and doing dry runs locally, which use the same Docker images and Makefile as the Jenkins-based&nbsp;build.</p>
<h2 id="policy-preprocessing"><a class="toclink" href="#policy-preprocessing">Policy&nbsp;Preprocessing</a></h2>
<p>Our <a href="#policygenpy">policygen.py</a> script is responsible for reading in the directory of per-policy <span class="caps">YAML</span> files,
performing some sanity checks on them, interpolating defaults from a <a href="#defaultsyml">policies/defaults.yml</a> file,
and then writing out the single <code>custodian.yml</code> that Cloud Custodian actually runs. The overall program flow is as&nbsp;follows:</p>
<ol>
<li>Read in all <code>.yml</code> files from the <code>policies/</code> directory; build a dict of policy names to the policy contents, deserialized from <span class="caps">YAML</span> into native Python data structures. For each policy file, ensure that the filename without the extension (i.e. the basename) matches the value of the &#8220;name&#8221; key in the policy <span class="caps">YAML</span>; raise an exception if any policies do not have a filename that matches their policy&nbsp;name.</li>
<li>Remove the <code>defaults</code> policy from that dict, and store it separately for later&nbsp;use.</li>
<li>Iterate over all policies in the dict, lexicographically by policy name; for each of them, interpolate our defaults into the policy and append the result to a &#8220;policies&#8221; list. See below for details of the defaults interpolation&nbsp;process.</li>
<li>Generate &#8220;cleanup&#8221; policies and append them to the list. This step is a holdover from before cloud-custodian had the <a href="https://github.com/capitalone/cloud-custodian/blob/master/tools/ops/mugc.py">mugc Lambda cleanup tool</a> but we still use it; this uses the names of all current policies to generate two policies that identify Lambda functions and CloudWatch Event Targets, respectively, that were provisioned by Cloud Custodian for policies that no longer exist. The resulting policies run once per day, and email us if there are any &#8220;orphaned&#8221; Cloud Custodian functions or&nbsp;rules.</li>
<li>Run a series of sanity and safety checks on the generated policies (see &#8220;Policy Sanity Checks&#8221;, below, for more&nbsp;information).</li>
<li>Write the final <code>custodian.yml</code> that will be used by Cloud Custodian, containing all of our final&nbsp;policies.</li>
<li>Write a <code>policies.rst</code> file that will be incorporated into our Sphinx-generated <span class="caps">HTML</span> documentation site. This file contains a table with one row per policy for all of our policies; the first column is the policy name as a <span class="caps">HTML</span> link to the policy <code>.yml</code> file in the git repository, and the second column is the text of the policy&#8217;s <code>comment</code> or <code>comments</code> field.</li>
</ol>
<h3 id="interpolating-defaults-into-policies"><a class="toclink" href="#interpolating-defaults-into-policies">Interpolating Defaults into&nbsp;Policies</a></h3>
<p>The most important part of <code>policygen.py</code> is the interpolation of defaults into policies.
When we originally deployed Cloud Custodian in our test environment, we noticed that our
policies had two large blocks that were almost identical across all policies: the <code>mode</code>
configuration telling Cloud Custodian to deploy the policies as Lambda functions triggered
by periodic CloudWatch Events rules, and the notification action that we use for email
notifications. This was the genesis of <code>policygen.py</code>; we moved these common policy
sections to a <code>defaults.yml</code> file, and wrote <code>policygen.py</code> to perform intelligent
merging of the defaults with each policy file, allowing us to override defaults in the
individual policies but still keep some mandatory&nbsp;settings.</p>
<p><a name="defaultsyml"></a>
Our <code>defaults.yml</code> file currently looks like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="c1"># <span class="caps">IMPORTANT</span> <span class="caps">NOTE</span>: **<span class="caps">ALL</span>** policies will have an additional notification action for the Splunk <span class="caps">SQS</span> queue</span>
<span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">periodic</span>
  <span class="c1"># This will trigger our rules at 15:20 <span class="caps">UTC</span> (11:20 <span class="caps">EDT</span> / 10:20 <span class="caps">EST</span>)</span>
  <span class="c1"># it might be better to spread them out over time a bit, but right now our</span>
  <span class="c1"># main concern is ensuring that policies run during work hours.</span>
  <span class="l l-Scalar l-Scalar-Plain">schedule</span><span class="p p-Indicator">:</span> <span class="s">&#39;cron(20</span><span class="nv"> </span><span class="s">15</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">?</span><span class="nv"> </span><span class="s">*)&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">300</span>
  <span class="l l-Scalar l-Scalar-Plain">execution-options</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">log_group</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/cloud-custodian/123456789012/us-east-1</span>
    <span class="l l-Scalar l-Scalar-Plain">output_dir</span><span class="p p-Indicator">:</span> <span class="s">&#39;s3://<span class="caps">SOME</span>-<span class="caps">BUCKET</span>-<span class="caps">NAME</span>/logs&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">dead_letter_config</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">TargetArn</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">arn:aws:sqs:us-east-1:123456789012:cloud-custodian-123456789012-deadletter</span>
  <span class="l l-Scalar l-Scalar-Plain">role</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">arn:aws:iam::123456789012:role/cloud-custodian-123456789012</span>
  <span class="l l-Scalar l-Scalar-Plain">tags</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">Project</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cloud-custodian</span>
    <span class="l l-Scalar l-Scalar-Plain">Environment</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dev</span>
    <span class="l l-Scalar l-Scalar-Plain">OwnerEmail</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us@example.com</span>
<span class="l l-Scalar l-Scalar-Plain">actions</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
    <span class="l l-Scalar l-Scalar-Plain">questions_email</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">us@example.com</span>
    <span class="l l-Scalar l-Scalar-Plain">questions_slack</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ourChannelName</span>
    <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">redefault.html</span>
    <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">us@example.com</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">awsusers@example.com</span>
    <span class="l l-Scalar l-Scalar-Plain">transport</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
      <span class="l l-Scalar l-Scalar-Plain">queue</span><span class="p p-Indicator">:</span> <span class="s">&#39;https://sqs.us-east-1.amazonaws.com/123456789012/cloud-custodian-123456789012&#39;</span>
</pre></div>


<p>This provides us with our default execution mode (Lambda function triggered once a day
at a defined time via CloudWatch Events) and its configuration options (mainly, the
<span class="caps">IAM</span> Role used for execution, the Dead Letter Queue, CloudWatch Log Group, and S3 output
configuration for policy results), as well as our default email notification configuration
using <span class="caps">SQS</span> to&nbsp;c7n-mailer.</p>
<p>All of these options can be overridden in individual policies intelligently; a simple example
policy that emails us about any <span class="caps">VPC</span> Peering Connections in a state other than
&#8220;active&#8221; would look&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="c1"># <span class="caps">REMINDER</span>: defaults.yml will be merged in to this. See the <span class="caps">README</span>.</span>
<span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">inactive-vpc-peers</span>
<span class="l l-Scalar l-Scalar-Plain">comment</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Notify <span class="caps">RE</span> of any <span class="caps">VPC</span> Peering Connections not in Active state (i.e. pending-acceptance, failed, etc.)</span>
<span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">peering-connection</span>
<span class="l l-Scalar l-Scalar-Plain">filters</span><span class="p p-Indicator">:</span>
  <span class="c1"># Peering Connection not in &quot;active&quot; state</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">value</span>
    <span class="l l-Scalar l-Scalar-Plain">key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Status.Code</span>
    <span class="l l-Scalar l-Scalar-Plain">op</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ne</span>
    <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&quot;active&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">actions</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
    <span class="l l-Scalar l-Scalar-Plain">violation_desc</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">The following <span class="caps">VPC</span> Peering Connections are in a state other than &quot;active&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">action_desc</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">likely need to be accepted, deleted, or investigated.</span>
    <span class="l l-Scalar l-Scalar-Plain">subject</span><span class="p p-Indicator">:</span> <span class="s">&#39;[cloud-custodian</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">account</span><span class="nv"> </span><span class="s">}}]</span><span class="nv"> </span><span class="s"><span class="caps">VPC</span></span><span class="nv"> </span><span class="s">Peering</span><span class="nv"> </span><span class="s">Connections</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">Active</span><span class="nv"> </span><span class="s">state</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">region</span><span class="nv"> </span><span class="s">}}&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">to</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">us@example.com</span>
</pre></div>


<p>This policy automatically inherits all of the <code>mode</code> defaults configuration and the <code>notify</code>
action is merged with the defaults; the resulting generated policy will combine all of the keys
in the defaults notification action and the policy notification action, with the exception of the
<code>to</code> block where the defaults are overridden by the&nbsp;policy.</p>
<p>The actual process of merging the policy and defaults is a recursive deep merge of the dicts, merging
the individual policy over a copy of the defaults, with special logic for lists and
<code>type: notify</code> actions. Overall, the procedure&nbsp;is:</p>
<ul>
<li>We start with <a href="#defaultsyml">policies/defaults.yml</a> as a base, and layer the policy-specific config on top of&nbsp;it.</li>
<li>We merge recursively (i.e. deep&nbsp;merging).</li>
<li>Keys from the policy overwrite identical keys in the defaults; the policy-specific config always wins over the&nbsp;defaults.</li>
<li>In the case of lists (i.e. the <code>actions</code> list), the end result includes all elements that are simple data types (i.e. strings). For
  dict items in lists, we look at the value of the <code>type</code> element; if both the policy and the defaults lists have
  dicts with the same <code>type</code>, we merge them together, with the policy overwriting the defaults. Defaults dicts without a
  matching <code>type</code> in the policy will always be in the final result, <strong>except for</strong> <code>actions</code> with a type of <code>notify</code>; policies that do
  not have a <code>type: notify</code> action will not have one added. This allows us to set defaults for dicts embedded in lists, like the
  <code>type: notify</code> action.</li>
<li>When finished merging, add a notification action to every policy that pushes to the Splunk queue, which is handled by our
  sqs_splunk_lambda&nbsp;code.</li>
</ul>
<p>To merge the two dicts together, we begin with a copy of the defaults and then iterate over all of the items in the policy as key/value pairs, updating the defaults as we go to build the final&nbsp;policy:</p>
<ul>
<li>If the key from the policy-specific config isn&#8217;t in the defaults, we add the key and value and move on.&nbsp;Otherwise;</li>
<li>If the value is a list, we use special list merging logic (see below) and update with the result of the list&nbsp;merge.</li>
<li>If the value is another dict, we call the same function recursively and update with its&nbsp;result.</li>
<li>If the value isn&#8217;t a list or dict, we assume it to be a simple type (string, int, etc.) and overwrite the default value with the one specified in the policy-specific&nbsp;configuration.</li>
<li>The end result of this is&nbsp;returned.</li>
</ul>
<p>List merging is somewhat special, to let us set defaults for&nbsp;actions:</p>
<ul>
<li>We begin with the policy itself as the base list, instead of the&nbsp;defaults.</li>
<li>Any non-dict items in defaults that aren&#8217;t in the policy are appended to the policy&nbsp;list.</li>
<li>Any dict items in the policy list with a <code>type</code> key/value pair that matches one of the dict items in the defaults list, will have additional key/value pairs added from the defaults&nbsp;dict.</li>
<li>Any defaults dicts not handled under the previous condition will be appended to the result, with the exception of a <code>type: notify</code> dict in the <code>['actions']</code> path.</li>
</ul>
<h3 id="policy-sanity-checks"><a class="toclink" href="#policy-sanity-checks">Policy Sanity&nbsp;Checks</a></h3>
<p>Before writing out the final <code>custodian.yml</code> configuration, each policy is run through a sanity/safety checking
function. The function is written to be easily extendable to add new policy checks (written in Python), but currently
only has two&nbsp;checks:</p>
<ol>
<li>
<p>Ensure that any <code>marked-for-op</code> filters come first in the filter list. When we originally
deployed Cloud Custodian, one of our policies had a <code>marked-for-op</code> filter (which allows Cloud Custodian to take action
on a resource that was specifically tagged for delayed action in the future) accidentally nested under an <code>or</code> clause
in the policy <span class="caps">YAML</span> (which was unfortunately easy to do, as it only required accidentally indenting the block two extra
spaces). This resulted in the policy taking action immediately instead of a week later, which could have been catastrophic
(luckily the action in this case was benign). To prevent this from happening again, our checks ensure that <code>marked-for-op</code>
filters, if present, always come at the beginning of the list of&nbsp;filters.</p>
</li>
<li>
<p>Ensure that any policies with <code>mark-for-op</code> actions also filter out resources that already have the cooresponding tag,
to prevent policies from constantly marking for a future date and never taking&nbsp;action.</p>
</li>
</ol>
<h2 id="conclusion"><a class="toclink" href="#conclusion">Conclusion</a></h2>
<p>We&#8217;re still in the process of expanding our Cloud Custodian deployment; right now we&#8217;re only running
it in one region of one non-production account, but that one region contains the vast majority of our infrastructure.
We&#8217;ll be expanding to other regions and then production accounts in the next few weeks, and that will require changing
some portions of our configuration, management, and policy generation code to compensate. So far we&#8217;ve seen good results
with using Cloud Custodian to enforce tagging and cost-reduction rules, such as terminating instances that have been
idle for a long time. We hope to continue extending the role that Cloud Custodian plays in cost reduction, and also
expand into enforcing more security and &#8220;housekeeping&#8221;&nbsp;policies.</p>
<h2 id="source-code"><a class="toclink" href="#source-code">Source&nbsp;Code</a></h2>
<p>The repository that we use for this is private, but I&#8217;ve been given permission to publish some of the generic portions
of the related code. I don&#8217;t really have an established method of publishing source code that I don&#8217;t &#8220;own&#8221; and
am not the authoritative source for, so I&#8217;m just going to leave it inline&nbsp;here&#8230;</p>
<h3 id="redefaulthtmlj2-email-template"><a class="toclink" href="#redefaulthtmlj2-email-template">redefault.html.j2 Email&nbsp;Template</a></h3>
<div class="highlight"><pre><span></span><span class="cp">&lt;!<span class="caps">DOCTYPE</span> html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>

<span class="c">{#</span>
<span class="c">Sample Policy that can be used with this template:</span>

<span class="c">Additional parameters can be passed in from the policy - i.e. action_desc, violation_desc</span>

<span class="c">  - name: delete-unencrypted-ec2</span>
<span class="c">    comments: Identifies <span class="caps">EC2</span> instances with unencrypted <span class="caps">EBS</span> volumes and terminates them.</span>
<span class="c">    resource: ec2</span>
<span class="c">    filters:</span>
<span class="c">      - type: ebs</span>
<span class="c">        key: Encrypted</span>
<span class="c">        value: false</span>
<span class="c">    actions:</span>
<span class="c">      - terminate</span>
<span class="c">      - type: notify</span>
<span class="c">        template: redefault.html</span>
<span class="c">        subject: &quot;[cloud-custodian {{ account }}] Unencrypted <span class="caps">EC2</span> Instances <span class="caps">DELETED</span> in {{ region }}&quot;</span>
<span class="c">        violation_desc: &quot;The following <span class="caps">EC2</span>(s) are not encrypted&quot;</span>
<span class="c">        action_desc: have been terminated per &lt;a href=&quot;https://docs.example.com/aws-policies&quot;&gt;standard policy&lt;/a&gt;</span>
<span class="c">        questions_email: you@example.com</span>
<span class="c">        questions_slack: YourSlackChannel</span>
<span class="c">        to:</span>
<span class="c">          - resource-owner</span>
<span class="c">          - example@yourdomain.com</span>
<span class="c">        transport:</span>
<span class="c">          type: sqs</span>
<span class="c">          queue: https://sqs.us-east-1.amazonaws.com/12345678910/custodian-sqs-queue</span>
<span class="c">#}</span>


<span class="c">{# You can set any mandatory tags here, and they will be formatted/outputted in the message #}</span>
<span class="cp">{%</span> <span class="k">set</span> <span class="nv">requiredTags</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">,</span><span class="s1">&#39;aws:autoscaling:groupName&#39;</span><span class="o">]</span> <span class="cp">%}</span>

<span class="c">{# The macros below format some resource attributes for better presentation #}</span>
<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">getTag</span><span class="o">(</span><span class="nv">resource</span><span class="o">,</span> <span class="nv">tagKey</span><span class="o">)</span> -<span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">resource.get</span><span class="o">(</span><span class="s1">&#39;Tags&#39;</span><span class="o">)</span> <span class="cp">%}</span>
        <span class="cp">{%</span> <span class="k">for</span> <span class="nv">t</span> <span class="k">in</span> <span class="nv">resource.get</span><span class="o">(</span><span class="s1">&#39;Tags&#39;</span><span class="o">)</span> <span class="cp">%}</span>
            <span class="cp">{%</span>  <span class="k">if</span> <span class="nv">t.get</span><span class="o">(</span><span class="s1">&#39;Key&#39;</span><span class="o">)|</span><span class="nf">lower</span> <span class="o">==</span> <span class="nv">tagKey</span><span class="o">|</span><span class="nf">lower</span> <span class="cp">%}</span>
                <span class="cp">{{</span> <span class="nv">t.get</span><span class="o">(</span><span class="s1">&#39;Value&#39;</span><span class="o">)</span> <span class="cp">}}</span>
            <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
        <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="cp">{%</span>- <span class="k">endmacro</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">extractList</span><span class="o">(</span><span class="nv">resource</span><span class="o">,</span> <span class="nv">column</span><span class="o">)</span> -<span class="cp">%}</span>
        <span class="cp">{%</span> <span class="k">for</span> <span class="nv">p</span> <span class="k">in</span> <span class="nv">resource.get</span><span class="o">(</span><span class="nv">column</span><span class="o">)</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">p</span> <span class="cp">}}</span>,
        <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="cp">{%</span>- <span class="k">endmacro</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">columnHeading</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">tableWidth</span><span class="o">)</span> -<span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;width: </span><span class="cp">{{</span> <span class="nv">tableWidth</span> <span class="cp">}}</span><span class="s">; border-spacing: 0px; box-shadow: 5px 5px 5px grey; border-collapse:separate; border-radius: 7px;&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">for</span> <span class="nv">columnName</span> <span class="k">in</span> <span class="nv">columnNames</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">set</span> <span class="nv">thstyle</span> <span class="o">=</span> <span class="s2">&quot;background: #a1bae2; color: white; border: 1px solid #a1bae2; text-align: center; padding: 5px;&quot;</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nb">loop</span><span class="nv">.index</span> <span class="o">==</span> <span class="m">1</span> <span class="cp">%}</span>
        <span class="p">&lt;</span><span class="nt">th</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">thstyle</span> <span class="cp">}}</span><span class="s"> border-top-left-radius: 7px;&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">columnName</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">elif</span> <span class="nb">loop</span><span class="nv">.index</span> <span class="o">==</span> <span class="nv">columnNames</span><span class="o">|</span><span class="nf">length</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">th</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">thstyle</span> <span class="cp">}}</span><span class="s"> border-top-right-radius: 7px;&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">columnName</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">th</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">thstyle</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">columnName</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
  <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="cp">{%</span>- <span class="k">endmacro</span> <span class="cp">%}</span>

<span class="c">{# This macro handles dotted column names, to retrieve nested dictionary values #}</span>
<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">columnValue</span><span class="o">(</span><span class="nv">resource</span><span class="o">,</span> <span class="nv">columnName</span><span class="o">)</span> <span class="cp">%}</span>
 <span class="cp">{%</span>- <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="k">not</span> <span class="k">in</span> <span class="nv">columnName</span> <span class="cp">%}</span>
<span class="cp">{{</span> <span class="nv">resource.get</span><span class="o">(</span><span class="nv">columnName</span><span class="o">)</span> <span class="cp">}}</span>
 <span class="cp">{%</span>- <span class="k">else</span> <span class="cp">%}</span>
<span class="cp">{{</span> <span class="nv">columnValue</span><span class="o">(</span><span class="nv">resource</span><span class="o">[</span><span class="nv">columnName</span><span class="o">[:</span><span class="nv">columnName.index</span><span class="o">(</span><span class="s1">&#39;.&#39;</span><span class="o">)]],</span> <span class="nv">columnName</span><span class="o">[</span><span class="nv">columnName.index</span><span class="o">(</span><span class="s1">&#39;.&#39;</span><span class="o">)+</span><span class="m">1</span><span class="o">:])</span> <span class="cp">}}</span>
 <span class="cp">{%</span>- <span class="k">endif</span> <span class="cp">%}</span>
<span class="cp">{%</span>- <span class="k">endmacro</span> <span class="cp">%}</span>

<span class="c">{# This macro creates a row in the table #}</span>
<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">tableRow</span><span class="o">(</span><span class="nv">resource</span><span class="o">,</span> <span class="nv">columnNames</span><span class="o">,</span> <span class="nv">loop_idx</span><span class="o">,</span> <span class="nv">res_len</span><span class="o">)</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">loop_idx</span> <span class="p">%</span> <span class="m">2</span> <span class="o">==</span> <span class="m">0</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">tr</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;background-color: #f2f2f2;&quot;</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">for</span> <span class="nv">columnName</span> <span class="k">in</span> <span class="nv">columnNames</span> <span class="cp">%}</span>
      <span class="cp">{%</span> <span class="k">set</span> <span class="nv">tdpart</span> <span class="o">=</span> <span class="s2">&quot;border: 1px solid grey; padding: 4px;&quot;</span> <span class="cp">%}</span>
      <span class="cp">{%</span> <span class="k">if</span> <span class="nv">loop_idx</span> <span class="o">==</span> <span class="nv">res_len</span> <span class="cp">%}</span>
        <span class="c">{# last row in table #}</span>
        <span class="cp">{%</span> <span class="k">if</span> <span class="nb">loop</span><span class="nv">.index</span> <span class="o">==</span> <span class="m">1</span> <span class="cp">%}</span>
          <span class="c">{# first td in row #}</span>
          <span class="cp">{%</span> <span class="k">set</span> <span class="nv">tdpart</span> <span class="o">=</span> <span class="s2">&quot;%s border-bottom-left-radius: 7px;&quot;</span> <span class="p">%</span> <span class="nv">tdpart</span> <span class="cp">%}</span>
        <span class="cp">{%</span> <span class="k">elif</span> <span class="nb">loop</span><span class="nv">.index</span> <span class="o">==</span> <span class="nv">columnNames</span><span class="o">|</span><span class="nf">length</span> <span class="cp">%}</span>
          <span class="c">{# last td in row #}</span>
          <span class="cp">{%</span> <span class="k">set</span> <span class="nv">tdpart</span> <span class="o">=</span> <span class="s2">&quot;%s border-bottom-right-radius: 7px;&quot;</span> <span class="p">%</span> <span class="nv">tdpart</span> <span class="cp">%}</span>
        <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
      <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
      <span class="cp">{%</span> <span class="k">if</span> <span class="nv">columnName</span> <span class="k">in</span> <span class="nv">requiredTags</span> <span class="cp">%}</span>
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">tdpart</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">getTag</span><span class="o">(</span><span class="nv">resource</span><span class="o">,</span><span class="nv">columnName</span><span class="o">)</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">columnName</span> <span class="o">==</span> <span class="s1">&#39;tag.Name&#39;</span> <span class="cp">%}</span>
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">tdpart</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">getTag</span><span class="o">(</span><span class="nv">resource</span><span class="o">,</span><span class="s1">&#39;Name&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">columnName</span> <span class="o">==</span> <span class="s1">&#39;InstanceCount&#39;</span> <span class="cp">%}</span>
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">align</span><span class="o">=</span><span class="s">&quot;center&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">tdpart</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">resource</span><span class="o">[</span><span class="s1">&#39;Instances&#39;</span><span class="o">]</span> <span class="o">|</span> <span class="nf">length</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">columnName</span> <span class="o">==</span> <span class="s1">&#39;VolumeConsumedReadWriteOps&#39;</span> <span class="cp">%}</span>
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">tdpart</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">resource</span><span class="o">[</span><span class="s1">&#39;c7n.metrics&#39;</span><span class="o">][</span><span class="s1">&#39;<span class="caps">AWS</span>/<span class="caps">EBS</span>.VolumeConsumedReadWriteOps.Maximum&#39;</span><span class="o">][</span><span class="m">0</span><span class="o">][</span><span class="s1">&#39;Maximum&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">columnName</span> <span class="o">==</span> <span class="s1">&#39;PublicIp&#39;</span> <span class="cp">%}</span>
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">tdpart</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">resource</span><span class="o">[</span><span class="s1">&#39;NetworkInterfaces&#39;</span><span class="o">][</span><span class="m">0</span><span class="o">]</span><span class="nv">.get</span><span class="o">(</span><span class="s1">&#39;Association&#39;</span><span class="o">)[</span><span class="s1">&#39;PublicIp&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">tdpart</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">columnValue</span><span class="o">(</span><span class="nv">resource</span><span class="o">,</span> <span class="nv">columnName</span><span class="o">)</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
      <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
    <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
<span class="cp">{%</span>- <span class="k">endmacro</span> <span class="cp">%}</span>

<span class="c">{# The macro below creates the table:</span>
<span class="c">   Formatting can be dependent on the column names that are passed in</span>
<span class="c">#}</span>
<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">columnData</span><span class="o">(</span><span class="nv">resources</span><span class="o">,</span> <span class="nv">columnNames</span><span class="o">)</span> -<span class="cp">%}</span>
  <span class="cp">{%</span> <span class="k">set</span> <span class="nv">len</span> <span class="o">=</span> <span class="nv">resources</span><span class="o">|</span><span class="nf">length</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">for</span> <span class="nv">resource</span> <span class="k">in</span> <span class="nv">resources</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">set</span> <span class="nv">idx</span> <span class="o">=</span> <span class="nb">loop</span><span class="nv">.index</span> <span class="cp">%}</span>
        <span class="cp">{{</span> <span class="nv">tableRow</span><span class="o">(</span><span class="nv">resource</span><span class="o">,</span> <span class="nv">columnNames</span><span class="o">,</span> <span class="nv">idx</span><span class="o">,</span> <span class="nv">len</span><span class="o">)</span> <span class="cp">}}</span>
    <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="cp">{%</span>- <span class="k">endmacro</span> <span class="cp">%}</span>

<span class="c">{# Main #}</span>
<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="nv">tableWidth</span><span class="o">)</span> <span class="cp">%}</span>
    <span class="cp">{{</span> <span class="nv">columnHeading</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">tableWidth</span><span class="o">)</span> <span class="cp">}}</span>
    <span class="cp">{{</span> <span class="nv">columnData</span><span class="o">(</span><span class="nv">resources</span><span class="o">,</span> <span class="nv">columnNames</span><span class="o">)</span> <span class="cp">}}</span>
<span class="cp">{%</span>- <span class="k">endmacro</span> <span class="cp">%}</span>

<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Cloud Custodian Notification - <span class="cp">{{</span>  <span class="s2">&quot;%s - %s&quot;</span> <span class="o">|</span> <span class="nf">format</span><span class="o">(</span><span class="nv">account</span><span class="o">,</span><span class="nv">region</span><span class="o">)</span>  <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;&lt;</span><span class="nt">font</span> <span class="na">color</span><span class="o">=</span><span class="s">&quot;#505151&quot;</span><span class="p">&gt;</span><span class="cp">{{</span>  <span class="s2">&quot;%s - %s&quot;</span> <span class="o">|</span> <span class="nf">format</span><span class="o">(</span><span class="nv">account</span><span class="o">,</span><span class="nv">region</span><span class="o">)</span>  <span class="cp">}}</span> cloud custodian (<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://github.com/example/custodian-config/&quot;</span><span class="p">&gt;</span>docs<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>)<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">action</span><span class="o">[</span><span class="s1">&#39;action_desc&#39;</span><span class="o">]</span> <span class="cp">%}</span>
        <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span> <span class="cp">{{</span>  <span class="nv">action</span><span class="o">[</span><span class="s1">&#39;violation_desc&#39;</span><span class="o">]</span>  <span class="cp">}}</span> and <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span><span class="cp">{{</span>  <span class="nv">action</span><span class="o">[</span><span class="s1">&#39;action_desc&#39;</span><span class="o">]</span>  <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>:<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span> <span class="cp">{{</span>  <span class="nv">action</span><span class="o">[</span><span class="s1">&#39;violation_desc&#39;</span><span class="o">]</span>  <span class="cp">}}</span>:<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

        <span class="c">{# Below, notifications for any resource-type can be formatted with specific columns #}</span>
        <span class="cp">{%</span> <span class="k">if</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;ami&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;Name&#39;</span><span class="o">,</span><span class="s1">&#39;ImageId&#39;</span><span class="o">,</span><span class="s1">&#39;CreationDate&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;60&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;app-elb&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;LoadBalancerName&#39;</span><span class="o">,</span><span class="s1">&#39;CreatedTime&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;asg&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">if</span> <span class="nv">resources</span><span class="o">[</span><span class="m">0</span><span class="o">][</span><span class="s1">&#39;Invalid&#39;</span><span class="o">]</span> <span class="k">is</span> <span class="nf">defined</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;AutoScalingGroupName&#39;</span><span class="o">,</span><span class="s1">&#39;InstanceCount&#39;</span><span class="o">,</span><span class="s1">&#39;Invalid&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;AutoScalingGroupName&#39;</span><span class="o">,</span><span class="s1">&#39;InstanceCount&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;60&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;cache-cluster&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;CacheClusterId&#39;</span><span class="o">,</span><span class="s1">&#39;CacheClusterCreateTime&#39;</span><span class="o">,</span><span class="s1">&#39;CacheClusterStatus&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;cache-snapshot&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;SnapshotName&#39;</span><span class="o">,</span><span class="s1">&#39;CacheClusterId&#39;</span><span class="o">,</span><span class="s1">&#39;SnapshotSource&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;cfn&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;StackName&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;50&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;cloudsearch&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;DomainName&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;50&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;ebs&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;VolumeId&#39;</span><span class="o">,</span><span class="s1">&#39;CreateTime&#39;</span><span class="o">,</span><span class="s1">&#39;State&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;50&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;ebs-snapshot&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;SnapshotId&#39;</span><span class="o">,</span><span class="s1">&#39;StartTime&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;ec2&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">if</span> <span class="nv">resources</span><span class="o">[</span><span class="m">0</span><span class="o">][</span><span class="s1">&#39;MatchedFilters&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="o">[</span><span class="s1">&#39;PublicIpAddress&#39;</span><span class="o">]</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;tag.Name&#39;</span><span class="o">,</span><span class="s1">&#39;PublicIp&#39;</span><span class="o">,</span><span class="s1">&#39;InstanceId&#39;</span><span class="o">,</span><span class="s1">&#39;ImageId&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">,</span><span class="s1">&#39;LaunchTime&#39;</span><span class="o">,</span><span class="s1">&#39;InstanceType&#39;</span><span class="o">,</span><span class="s1">&#39;aws:autoscaling:groupName&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;tag.Name&#39;</span><span class="o">,</span><span class="s1">&#39;PrivateIpAddress&#39;</span><span class="o">,</span><span class="s1">&#39;InstanceId&#39;</span><span class="o">,</span><span class="s1">&#39;ImageId&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">,</span><span class="s1">&#39;LaunchTime&#39;</span><span class="o">,</span><span class="s1">&#39;InstanceType&#39;</span><span class="o">,</span><span class="s1">&#39;aws:autoscaling:groupName&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;efs&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;CreationToken&#39;</span><span class="o">,</span><span class="s1">&#39;CreationTime&#39;</span><span class="o">,</span><span class="s1">&#39;FileSystemId&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerId&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;50&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;elasticsearch&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;DomainName&#39;</span><span class="o">,</span><span class="s1">&#39;Endpoint&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;50&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;elb&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;LoadBalancerName&#39;</span><span class="o">,</span><span class="s1">&#39;InstanceCount&#39;</span><span class="o">,</span><span class="s1">&#39;AvailabilityZones&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;emr&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;Id&#39;</span><span class="o">,</span><span class="s1">&#39;EmrState&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;50&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;kinesis&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;KinesisName&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;50&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;launch-config&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;LaunchConfigurationName&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;30&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;log-group&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;logGroupName&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;30&#39;</span><span class="o">)</span> <span class="cp">}}</span>

    <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;peering-connection&quot;</span> <span class="cp">%}</span>
      <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;VpcPeeringConnectionId&#39;</span><span class="o">,</span> <span class="s1">&#39;Status.Code&#39;</span><span class="o">,</span> <span class="s1">&#39;Status.Message&#39;</span><span class="o">,</span> <span class="s1">&#39;ExpirationTime&#39;</span><span class="o">,</span> <span class="s1">&#39;RequesterVpcInfo.OwnerId&#39;</span><span class="o">,</span> <span class="s1">&#39;RequesterVpcInfo.VpcId&#39;</span><span class="o">,</span> <span class="s1">&#39;RequesterVpcInfo.CidrBlock&#39;</span><span class="o">,</span> <span class="s1">&#39;AccepterVpcInfo.OwnerId&#39;</span><span class="o">,</span> <span class="s1">&#39;AccepterVpcInfo.VpcId&#39;</span><span class="o">,</span> <span class="s1">&#39;AccepterVpcInfo.CidrBlock&#39;</span><span class="o">]</span> <span class="cp">%}</span>
      <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;rds&quot;</span> <span class="cp">%}</span>
          <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;DBInstanceIdentifier&#39;</span><span class="o">,</span><span class="s1">&#39;DBName&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">,</span><span class="s1">&#39;Engine&#39;</span><span class="o">,</span><span class="s1">&#39;DBInstanceClass&#39;</span><span class="o">,</span><span class="s1">&#39;MultiAZ&#39;</span><span class="o">,</span><span class="s1">&#39;PubliclyAccessible&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;rds-snapshot&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;DBSnapshotIdentifier&#39;</span><span class="o">,</span><span class="s1">&#39;SnapshotCreateTime&#39;</span><span class="o">,</span><span class="s1">&#39;DBInstanceIdentifier&#39;</span><span class="o">,</span><span class="s1">&#39;SnapshotType&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;redshift&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">if</span> <span class="nv">resources</span><span class="o">[</span><span class="m">0</span><span class="o">][</span><span class="s1">&#39;PubliclyAccessible&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="kp">true</span> <span class="k">or</span> <span class="nv">resources</span><span class="o">[</span><span class="m">0</span><span class="o">][</span><span class="s1">&#39;Encrypted&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="kp">false</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;ClusterIdentifier&#39;</span><span class="o">,</span><span class="s1">&#39;NodeCount&#39;</span><span class="o">,</span><span class="s1">&#39;PubliclyAccessible&#39;</span><span class="o">,</span><span class="s1">&#39;Encrypted&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;ClusterIdentifier&#39;</span><span class="o">,</span><span class="s1">&#39;NodeCount&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;redshift-snapshot&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;SnapshotIdentifier&#39;</span><span class="o">,</span><span class="s1">&#39;DBName&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;s3&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">if</span> <span class="nv">resources</span><span class="o">[</span><span class="m">0</span><span class="o">][</span><span class="s1">&#39;GlobalPermissions&#39;</span><span class="o">]</span> <span class="k">is</span> <span class="nf">defined</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;Name&#39;</span><span class="o">,</span><span class="s1">&#39;GlobalPermissions&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;Name&#39;</span><span class="o">,</span><span class="s1">&#39;Project&#39;</span><span class="o">,</span><span class="s1">&#39;Component&#39;</span><span class="o">,</span><span class="s1">&#39;Environment&#39;</span><span class="o">,</span><span class="s1">&#39;OwnerEmail&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;security-group&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;GroupName&#39;</span><span class="o">,</span><span class="s1">&#39;tag.Name&#39;</span><span class="o">,</span><span class="s1">&#39;GroupId&#39;</span><span class="o">,</span><span class="s1">&#39;VpcId&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;80&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="cp">{%</span> <span class="k">elif</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;resource&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;simpledb&quot;</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;DomainName&#39;</span><span class="o">]</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;60&#39;</span><span class="o">)</span> <span class="cp">}}</span>

        <span class="c">{# If no special formatting is defined for a resource type, all attributes will be formatted in the email #}</span>
        <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
      <span class="cp">{%</span> <span class="k">set</span> <span class="nv">columnNames</span> <span class="o">=</span> <span class="nv">resources</span><span class="o">[</span><span class="m">0</span><span class="o">]</span><span class="nv">.keys</span><span class="o">()</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">createTable</span><span class="o">(</span><span class="nv">columnNames</span><span class="o">,</span> <span class="nv">resources</span><span class="o">,</span> <span class="s1">&#39;100&#39;</span><span class="o">)</span> <span class="cp">}}</span>
        <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

        <span class="p">&lt;</span><span class="nt">h4</span><span class="p">&gt;</span>
            For any other questions, contact <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;mailto:</span><span class="cp">{{</span> <span class="nv">action</span><span class="o">[</span><span class="s1">&#39;questions_email&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">action</span><span class="o">[</span><span class="s1">&#39;questions_email&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
      or <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://example.slack.com/messages/</span><span class="cp">{{</span> <span class="nv">action</span><span class="o">[</span><span class="s1">&#39;questions_slack&#39;</span><span class="o">]</span> <span class="cp">}}</span><span class="s">/&quot;</span><span class="p">&gt;</span>#<span class="cp">{{</span> <span class="nv">action</span><span class="o">[</span><span class="s1">&#39;questions_slack&#39;</span><span class="o">]</span> <span class="cp">}}</span> on Slack<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.
      Documentation for our cloud-custodian instance and policies can be found at: <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://github.com/example/custodian-config/&quot;</span><span class="p">&gt;</span>https://github.com/example/custodian-config/<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.
    <span class="p">&lt;/</span><span class="nt">h4</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Generated by cloud-custodian policy: <span class="cp">{{</span> <span class="nv">policy</span><span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="cp">}}</span> in <span class="cp">{{</span> <span class="nv">account</span> <span class="cp">}}</span> <span class="cp">{{</span> <span class="nv">region</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>


<h3 id="jenkinsfile"><a class="toclink" href="#jenkinsfile">Jenkinsfile</a></h3>
<div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env groovy</span>

<span class="n">node</span> <span class="o">{</span>
    <span class="n">deleteDir</span><span class="o">()</span>
    <span class="n">checkout</span> <span class="n">scm</span>

    <span class="nf">wrap</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;AnsiColorBuildWrapper&#39;</span><span class="o">,</span> <span class="s1">&#39;colorMapName&#39;</span><span class="o">:</span> <span class="s1">&#39;XTerm&#39;</span><span class="o">,</span> <span class="s1">&#39;defaultFg&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="o">,</span> <span class="s1">&#39;defaultBg&#39;</span><span class="o">:</span> <span class="mi">2</span><span class="o">])</span> <span class="o">{</span>
      <span class="n">wrap</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;TimestamperBuildWrapper&#39;</span><span class="o">])</span> <span class="o">{</span>

        <span class="kt">def</span> <span class="n">environment</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">image</span><span class="o">(</span><span class="s1">&#39;python:2-wheezy&#39;</span><span class="o">)</span>
        <span class="kt">def</span> <span class="n">tfimg</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="na">image</span><span class="o">(</span><span class="s1">&#39;hashicorp/terraform:0.9.6&#39;</span><span class="o">)</span>
        <span class="kt">def</span> <span class="n">gitUrl</span> <span class="o">=</span> <span class="n">sh</span><span class="o">(</span><span class="nl">script:</span> <span class="s2">&quot;git config remote.origin.url&quot;</span><span class="o">,</span> <span class="nl">returnStdout:</span> <span class="kc">true</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">gitCommit</span> <span class="o">=</span> <span class="n">sh</span><span class="o">(</span><span class="nl">script:</span> <span class="s2">&quot;git rev-parse <span class="caps">HEAD</span>&quot;</span><span class="o">,</span> <span class="nl">returnStdout:</span> <span class="kc">true</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">repo</span>   <span class="o">=</span> <span class="s1">&#39;github.com/example/custodian-config&#39;</span>

        <span class="k">try</span> <span class="o">{</span>
          <span class="n">tfimg</span><span class="o">.</span><span class="na">inside</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">BRANCH_NAME</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Terraform Apply&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;cd terraform &amp;&amp; ./run.sh apply&quot;</span>
              <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Terraform Plan&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;cd terraform &amp;&amp; ./run.sh plan&quot;</span>
              <span class="o">}</span>
            <span class="o">}</span>
          <span class="o">}</span> <span class="c1">// tfimg</span>

          <span class="c1">// run as user 0 group 0 - see comment in Setup Virtualenv stage</span>
          <span class="n">environment</span><span class="o">.</span><span class="na">inside</span><span class="o">(</span><span class="s1">&#39;-u 0:0&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">withEnv</span><span class="o">([</span><span class="s2">&quot;GIT_COMMIT=${gitCommit}&quot;</span><span class="o">])</span> <span class="o">{</span>
              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Setup Virtualenv&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="cm">/*</span>
<span class="cm">                 * If we run the container as 1000:1000 (which Jenkins will do by</span>
<span class="cm">                 * default), we can&#39;t pip install from a git <span class="caps">URL</span> in the container,</span>
<span class="cm">                 * because we&#39;re running as a user not present in /etc/passwd. But</span>
<span class="cm">                 * running as 0:0 has the side effect that any files we create</span>
<span class="cm">                 * in `pwd` (the workspace, mounted <span class="caps">RW</span> into the container) will be</span>
<span class="cm">                 * owned 0:0 (even on the host)... which means deleteDir() will fail</span>
<span class="cm">                 * with permissions errors. The simple solution is to not touch</span>
<span class="cm">                 * anything in the workspace at all; copy it to a path that exists</span>
<span class="cm">                 * only in the container and mess with it there.</span>
<span class="cm">                 */</span>
                <span class="n">sh</span> <span class="s2">&quot;mkdir /app &amp;&amp; cp -a . /app &amp;&amp; cd /app &amp;&amp; virtualenv --no-site-packages -p python2.7 .&quot;</span>
              <span class="o">}</span>
              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Install tox&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;cd /app &amp;&amp; . bin/activate &amp;&amp; pip install tox&quot;</span>
              <span class="o">}</span>
              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Test policygen.py&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;cd /app &amp;&amp; . bin/activate &amp;&amp; tox&quot;</span>
              <span class="o">}</span>
              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Test sqs_splunk_lambda&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;cd /app/sqs_splunk_lambda &amp;&amp; . ../bin/activate &amp;&amp; tox&quot;</span>
              <span class="o">}</span>
              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Validate&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;cd /app &amp;&amp; make validate &amp;&amp; cat custodian.yml &amp;&amp; cat policies.rst&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;cp /app/custodian.yml . &amp;&amp; cp /app/policies.rst .&quot;</span>
                <span class="n">archiveArtifacts</span> <span class="nl">artifacts:</span> <span class="s2">&quot;custodian.yml,policies.rst&quot;</span><span class="o">,</span> <span class="nl">allowEmptyArchive:</span> <span class="kc">true</span>
              <span class="o">}</span>

              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Lambda Garbage Collection Dry Run&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;cd /app &amp;&amp; make mugc-dryrun&quot;</span>
              <span class="o">}</span>

              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Dry Run&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;cd /app &amp;&amp; make dryrun&quot;</span>
                <span class="n">sh</span> <span class="s2">&quot;cp -a /app/dryrun . &amp;&amp; chown -R 1000:1000 .&quot;</span>
                <span class="n">archiveArtifacts</span> <span class="nl">artifacts:</span> <span class="s2">&quot;custodian.yml,policies.rst,dryrun/**/*&quot;</span><span class="o">,</span> <span class="nl">allowEmptyArchive:</span> <span class="kc">true</span>
              <span class="o">}</span>

              <span class="k">if</span> <span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">BRANCH_NAME</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Lambda Garbage Collection&#39;</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">sh</span> <span class="s2">&quot;cd /app &amp;&amp; make mugc&quot;</span>
                <span class="o">}</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Install and Provision Mailer&#39;</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">sh</span> <span class="s2">&quot;cd /app &amp;&amp; make run mailer&quot;</span>
                <span class="o">}</span>
              <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Install Mailer&#39;</span><span class="o">)</span> <span class="o">{</span>
                  <span class="c1">// not master - install deps but don&#39;t run mailer</span>
                  <span class="n">sh</span> <span class="s2">&quot;cd /app &amp;&amp; make mailerdeps &amp;&amp; cat mailer.yml&quot;</span>
                <span class="o">}</span>
              <span class="o">}</span>

              <span class="c1">// sqs_splunk_lambda needs Vault creds</span>
              <span class="kt">def</span> <span class="n">secrets</span> <span class="o">=</span>  <span class="o">[</span>
                  <span class="o">[</span>
                    <span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;VaultSecret&#39;</span><span class="o">,</span>
                    <span class="nl">path:</span> <span class="s1">&#39;some/path&#39;</span><span class="o">,</span>
                    <span class="nl">secretValues:</span> <span class="o">[</span>
                      <span class="c1">// redacted; get some secrets, and set them in the environment</span>
                    <span class="o">]</span>
                  <span class="o">]</span>
              <span class="o">]</span>

              <span class="n">wrap</span><span class="o">([</span><span class="n">$class</span><span class="o">:</span> <span class="s1">&#39;VaultBuildWrapper&#39;</span><span class="o">,</span> <span class="nl">vaultSecrets:</span> <span class="n">secrets</span><span class="o">])</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">BRANCH_NAME</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Install and provision sqs_splunk_lambda&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s2">&quot;cd /app/sqs_splunk_lambda &amp;&amp; . ../bin/activate &amp;&amp; python setup.py develop&quot;</span>
                    <span class="n">sh</span> <span class="s2">&quot;cd /app &amp;&amp; . bin/activate &amp;&amp; sqs_splunk_lambda -c sqs_splunk_lambda.yml --update-lambda&quot;</span>
                  <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                  <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Install and verify sqs_splunk_lambda&#39;</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sh</span> <span class="s2">&quot;cd /app/sqs_splunk_lambda &amp;&amp; . ../bin/activate &amp;&amp; python setup.py develop&quot;</span>
                    <span class="n">sh</span> <span class="s2">&quot;cd /app &amp;&amp; . bin/activate &amp;&amp; sqs_splunk_lambda -c sqs_splunk_lambda.yml --validate&quot;</span>
                  <span class="o">}</span>
                <span class="o">}</span>
              <span class="o">}</span> <span class="c1">// wrap</span>

              <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Build Docs&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sh</span> <span class="s2">&quot;cd /app &amp;&amp; make docs&quot;</span>
              <span class="o">}</span>

              <span class="k">if</span> <span class="o">(</span><span class="n">env</span><span class="o">.</span><span class="na">BRANCH_NAME</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Publish Docs&#39;</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">withCredentials</span><span class="o">([</span><span class="n">usernamePassword</span><span class="o">(</span><span class="nl">credentialsId:</span> <span class="s1">&#39;SomeID&#39;</span><span class="o">,</span> <span class="nl">passwordVariable:</span> <span class="s1">&#39;GIT_PASS&#39;</span><span class="o">,</span> <span class="nl">usernameVariable:</span> <span class="s1">&#39;GIT_USER&#39;</span><span class="o">)])</span> <span class="o">{</span>
                    <span class="n">sh</span><span class="o">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                      cd /app/docs/_build/</span>
<span class="s2">                      git init</span>
<span class="s2">                      git config user.name &quot;jenkins&quot;</span>
<span class="s2">                      git config user.email &quot;jenkins@example.com&quot;</span>
<span class="s2">                      git remote add origin git@${repo}</span>
<span class="s2">                      git checkout -b gh-pages</span>

<span class="s2">                      git add --all</span>
<span class="s2">                      git commit -m &quot;docs published by ${env.BUILD_URL}&quot;</span>
<span class="s2">                      git push -f &quot;https://${env.GIT_PASS}@${repo}&quot; <span class="caps">HEAD</span>:gh-pages</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="o">)</span>
                  <span class="o">}</span> <span class="c1">// withCredentials</span>
                <span class="o">}</span> <span class="c1">// stage(&#39;Publish Docs&#39;)</span>

                <span class="n">stage</span><span class="o">(</span><span class="s1">&#39;Apply Job <span class="caps">DSL</span> for errorscan.py cron-based Jenkins job&#39;</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">build</span> <span class="nl">job:</span> <span class="s1">&#39;SeedJob&#39;</span><span class="o">,</span> <span class="nl">parameters:</span> <span class="o">[</span>
                    <span class="n">string</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">&#39;APP_NAME&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;cloud-custodian&#39;</span><span class="o">),</span>
                    <span class="n">string</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">&#39;APP_REPO&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;git@github.com:example/custodian-config&#39;</span><span class="o">),</span>
                    <span class="n">string</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">&#39;PATH_TO_DSL&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;config/pipeline.groovy&#39;</span><span class="o">),</span>
                    <span class="n">string</span><span class="o">(</span><span class="nl">name:</span> <span class="s1">&#39;APP_REPO_BRANCH&#39;</span><span class="o">,</span> <span class="nl">value:</span> <span class="s1">&#39;master&#39;</span><span class="o">)</span>
                  <span class="o">]</span>
                <span class="o">}</span> <span class="c1">// stage</span>
              <span class="o">}</span> <span class="c1">// if env.BRANCH_NAME == &#39;master&#39;</span>
            <span class="o">}</span> <span class="c1">// withEnv</span>
          <span class="o">}</span> <span class="c1">//environment</span>
          <span class="n">currentBuild</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="s1">&#39;<span class="caps">SUCCESS</span>&#39;</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">echo</span> <span class="s2">&quot;Caught exception: ${ex.toString()}&quot;</span>
          <span class="n">currentBuild</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="s1">&#39;<span class="caps">FAILURE</span>&#39;</span>
          <span class="k">throw</span> <span class="n">ex</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="n">echo</span> <span class="s2">&quot;Build result: ${currentBuild.result}&quot;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">currentBuild</span><span class="o">.</span><span class="na">result</span> <span class="o">==</span> <span class="s1">&#39;<span class="caps">SUCCESS</span>&#39;</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">slackSend</span><span class="o">(</span><span class="nl">color:</span> <span class="s1">&#39;good&#39;</span><span class="o">,</span> <span class="nl">message:</span> <span class="s2">&quot;<span class="caps">SUCCESS</span>: ${env.JOB_NAME} &lt;${env.BUILD_URL}|build ${env.BUILD_NUMBER}&gt;&quot;</span><span class="o">)</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">slackSend</span><span class="o">(</span><span class="nl">color:</span> <span class="s1">&#39;danger&#39;</span><span class="o">,</span> <span class="nl">message:</span> <span class="s2">&quot;<span class="caps">FAILED</span>: ${env.JOB_NAME} &lt;${env.BUILD_URL}|build ${env.BUILD_NUMBER}&gt;&quot;</span><span class="o">)</span>
          <span class="o">}</span>
        <span class="o">}</span>

      <span class="o">}</span> <span class="c1">// wrap TimestamperBuildWrapper</span>
    <span class="o">}</span> <span class="c1">// wrap AnsiColorBuildWrapper</span>
<span class="o">}</span>
</pre></div>


<h3 id="makefile"><a class="toclink" href="#makefile">Makefile</a></h3>
<div class="highlight"><pre><span></span><span class="nf">.<span class="caps">PHONY</span></span><span class="o">:</span> <span class="n">docs</span> <span class="n">clean</span>

<span class="nv"><span class="caps">PROJECT</span></span><span class="o">=</span><span class="k">$(</span>shell grep <span class="s2">&quot;project&quot;</span> terraform/terraform.tfvars <span class="p">|</span> cut -d<span class="o">=</span> -f2 <span class="p">|</span> tr -d <span class="s1">&#39;[[=&quot;=]],[[:space:]]&#39;</span><span class="k">)</span>
<span class="nv"><span class="caps">ENVIRONMENT</span></span><span class="o">=</span><span class="k">$(</span>shell grep <span class="s2">&quot;environment&quot;</span> terraform/terraform.tfvars <span class="p">|</span> cut -d<span class="o">=</span> -f2 <span class="p">|</span> tr -d <span class="s1">&#39;[[=&quot;=]],[[:space:]]&#39;</span><span class="k">)</span>
<span class="nv">ACCOUNT_ID</span><span class="o">=</span><span class="k">$(</span>shell aws sts get-caller-identity --region<span class="o">=</span><span class="k">$(</span><span class="caps">REGION</span><span class="k">)</span> --output text --query <span class="s1">&#39;Account&#39;</span><span class="k">)</span>
<span class="nv"><span class="caps">BUCKET</span></span><span class="o">=</span>s3://<span class="k">$(</span><span class="caps">PROJECT</span><span class="k">)</span>-<span class="k">$(</span>ACCOUNT_ID<span class="k">)</span>
<span class="nv"><span class="caps">REGION</span></span><span class="o">=</span>us-east-1
<span class="nv"><span class="caps">MARKDOWN</span></span> <span class="o">=</span> pandoc --from markdown_github --to html --standalone
<span class="nv">INSTALL_REPO</span><span class="o">=</span>git+https://github.com/capitalone/cloud-custodian.git
<span class="nv">INSTALL_REF</span><span class="o">=</span><span class="m">0</span>.8.26.0

<span class="nf">virtualenv</span><span class="o">:</span>
<span class="cp">    if [ ! -e &quot;./bin/activate_this.py&quot; ] ; then virtualenv --clear .; fi</span>

<span class="nf">deps</span><span class="o">:</span> <span class="n">virtualenv</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span>. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> <span class="se">\</span>
    pip install -e <span class="s2">&quot;</span><span class="k">$(</span>INSTALL_REPO<span class="k">)</span><span class="s2">@</span><span class="k">$(</span>INSTALL_REF<span class="k">)</span><span class="s2">#egg=c7n&quot;</span>

<span class="nf">mailerdeps</span><span class="o">:</span> <span class="n">deps</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span>. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> <span class="se">\</span>
    pip install -r src/c7n/tools/c7n_mailer/requirements.txt <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">cd</span> src/c7n/tools/c7n_mailer <span class="o">&amp;&amp;</span> <span class="se">\</span>
    python setup.py develop <span class="o">&amp;&amp;</span> <span class="se">\</span>
    <span class="nb">cd</span> ../../../../
    cp templates/* src/c7n/tools/c7n_mailer/msg-templates/

<span class="nf">clean</span><span class="o">:</span> <span class="n">clean</span>-<span class="n">build</span> <span class="n">clean</span>-<span class="n">pyc</span> <span class="n">clean</span>-<span class="n">test</span>

<span class="nf">clean-build</span><span class="o">:</span>
    rm -fr build/
    rm -fr dist/
    rm -fr .eggs/
    find . -name <span class="s1">&#39;*.egg-info&#39;</span> -exec rm -rf <span class="o">{}</span> +
    find . -name <span class="s1">&#39;*.egg&#39;</span> -exec rm -rf <span class="o">{}</span> +

<span class="nf">clean-pyc</span><span class="o">:</span>
    find . -name <span class="s1">&#39;*.pyc&#39;</span> -exec rm -f <span class="o">{}</span> +
    find . -name <span class="s1">&#39;*.pyo&#39;</span> -exec rm -f <span class="o">{}</span> +
    find . -name <span class="s1">&#39;*~&#39;</span> -exec rm -f <span class="o">{}</span> +
    find . -name <span class="s1">&#39;__pycache__&#39;</span> -exec rm -fr <span class="o">{}</span> +

<span class="nf">clean-test</span><span class="o">:</span>
    rm -fr .tox/
    rm -f .coverage
    rm -fr htmlcov/

<span class="nf">install</span><span class="o">:</span> <span class="n">clean</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span><span class="nv">$<span class="caps">PYTHONPATH</span></span>:.:. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> python setup.py install

<span class="nf">policies</span><span class="o">:</span> <span class="n">deps</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span>. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> ./policygen.py

<span class="nf">validate</span><span class="o">:</span> <span class="n">policies</span>
    <span class="nb">echo</span> <span class="s2">&quot;Running custodian in </span><span class="si">${</span><span class="nv"><span class="caps">ACCOUNT</span></span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span><span class="nv">$<span class="caps">PYTHONPATH</span></span>:.:. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> custodian validate -c custodian.yml

<span class="nf">dryrun</span><span class="o">:</span> <span class="n">validate</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span><span class="nv">$<span class="caps">PYTHONPATH</span></span>:.:. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> custodian run --region <span class="s1">&#39;$(<span class="caps">REGION</span>)&#39;</span> --dryrun -v -s dryrun -c custodian.yml --cache <span class="s1">&#39;/tmp/.cache/cloud-custodian.cache&#39;</span>

<span class="nf">run</span><span class="o">:</span> <span class="n">validate</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span><span class="nv">$<span class="caps">PYTHONPATH</span></span>:.:. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> custodian run --region <span class="s1">&#39;$(<span class="caps">REGION</span>)&#39;</span> --metrics -v -s <span class="k">$(</span><span class="caps">BUCKET</span><span class="k">)</span>/logs --log-group<span class="o">=</span>/cloud-custodian/<span class="k">$(</span>ACCOUNT_ID<span class="k">)</span>/<span class="k">$(</span><span class="caps">REGION</span><span class="k">)</span> -c custodian.yml --cache <span class="s1">&#39;/tmp/.cache/cloud-custodian.cache&#39;</span>

<span class="nf">mugc</span><span class="o">:</span> <span class="n">validate</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span><span class="nv">$<span class="caps">PYTHONPATH</span></span>:.:. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> python src/c7n/tools/ops/mugc.py -v -r <span class="s1">&#39;$(<span class="caps">REGION</span>)&#39;</span> -c custodian.yml

<span class="nf">mugc-dryrun</span><span class="o">:</span> <span class="n">validate</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span><span class="nv">$<span class="caps">PYTHONPATH</span></span>:.:. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> python src/c7n/tools/ops/mugc.py -v --dryrun -r <span class="s1">&#39;$(<span class="caps">REGION</span>)&#39;</span> -c custodian.yml

<span class="nf">config</span><span class="o">:</span>
    @echo <span class="k">$(</span><span class="caps">PROJECT</span><span class="k">)</span>
    @echo <span class="k">$(</span><span class="caps">ENVIRONMENT</span><span class="k">)</span>
    @echo <span class="k">$(</span><span class="caps">BUCKET</span><span class="k">)</span>

<span class="nf">mailer</span><span class="o">:</span> <span class="n">mailerdeps</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span><span class="nv">$<span class="caps">PYTHONPATH</span></span>:.:. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> c7n-mailer -c mailer.yml --update-lambda

<span class="nf">docdeps</span><span class="o">:</span> <span class="n">virtualenv</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span>. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> <span class="se">\</span>
    pip install <span class="nv">sphinx</span><span class="o">==</span><span class="m">1</span>.6.4 <span class="nv">sphinx_rtd_theme</span><span class="o">==</span><span class="m">0</span>.2.4

<span class="nf">docs</span><span class="o">:</span> <span class="n">docdeps</span>
<span class="cp">    if [ -e &quot;./docs/_build&quot; ] ; then rm -Rf docs/_build; fi</span>
    <span class="nv"><span class="caps">PYTHONPATH</span></span><span class="o">=</span>. <span class="p">;</span> . ./bin/activate <span class="o">&amp;&amp;</span> <span class="se">\</span>
    sphinx-build -W docs/source docs/_build -b dirhtml
</pre></div>


<h3 id="policygenpy"><a class="toclink" href="#policygenpy">policygen.py</a></h3>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">There are unit tests for this script; see `test_policygen.py`.</span>

<span class="sd">If you want to add a sanity/safety test to run against all policies during</span>
<span class="sd">the Jenkins build, see ``PolicyGen._check_policies()``.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">yaml</span> <span class="kn">import</span> <span class="n">CSafeLoader</span>

<span class="n">SafeLoader</span> <span class="o">=</span> <span class="n">CSafeLoader</span>
<span class="n">whtspc_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\s+&#39;</span><span class="p">)</span>

<span class="n">REPO_HTML</span> <span class="o">=</span> <span class="s1">&#39;https://github.com/example/custodian-config/&#39;</span>


<span class="k">def</span> <span class="nf">strip_doc</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a function or method reference, return its docstring as one line (with</span>
<span class="sd">    all newlines removed and all whitespace collapsed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">whtspc_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">timestr</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;just here to make unit testing simpler&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; <span class="caps">UTC</span>&#39;</span>


<span class="k">class</span> <span class="nc">PolicyGen</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1"># Configuration to send notifications to the splunk <span class="caps">SQS</span> queue for</span>
    <span class="c1"># sqs_splunk_lambda to pick up and send to <span class="caps">HEC</span></span>
    <span class="n">SPLUNK_SQS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
        <span class="c1"># &#39;template&#39; and &#39;to&#39; don&#39;t matter, but arerequired keys</span>
        <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="s1">&#39;redefault.html&#39;</span><span class="p">,</span>
        <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PlaceholderForSplunkSQSNotify&#39;</span><span class="p">],</span>
        <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="c1"># queue will be filled in by the __init__() method</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get the Splunk <span class="caps">SQS</span> queue <span class="caps">URL</span> from the config file</span>
        <span class="n">splunk_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file_yaml</span><span class="p">(</span><span class="s1">&#39;sqs_splunk_lambda.yml&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SPLUNK_SQS</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">][</span><span class="s1">&#39;queue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">splunk_conf</span><span class="p">[</span><span class="s1">&#39;queue_url&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_policies</span><span class="p">()</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">policies</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;defaults&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;policies&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">policies</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;policies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_defaults</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">policies</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Generating c7n cleanup policies...&#39;</span><span class="p">)</span>
        <span class="c1"># add c7n lambda/<span class="caps">CW</span> Even cleanup policies</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_cleanup_policies</span><span class="p">(</span>
            <span class="n">deepcopy</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;policies&#39;</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;policies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_defaults</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">pol</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Checking policies for sanity and safety...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_policies</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;policies&#39;</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Writing policies to custodian.yml...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_file</span><span class="p">(</span><span class="s1">&#39;custodian.yml&#39;</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Writing policy descriptions to policies.rst...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_file</span><span class="p">(</span><span class="s1">&#39;policies.rst&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy_rst</span><span class="p">(</span><span class="n">policies</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_policies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check all of our policies to ensure that they conform with some rules</span>
<span class="sd">        and best practices around safety and sanity.</span>

<span class="sd">        Each policy in ``policies`` is passed through each of the</span>
<span class="sd">        ``self._check_policy_*`` functions (which return a boolean pass/fail).</span>
<span class="sd">        At the end, all failures are collected. If there are any, SystemExit(1)</span>
<span class="sd">        is raised.</span>

<span class="sd">        :param policies: list of policy dictionaries</span>
<span class="sd">        :type policies: list</span>
<span class="sd">        :raises: SystemExit(1) if any policies failed checks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">policy_checks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_check_policy_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)):</span>
                <span class="n">policy_checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chk</span> <span class="ow">in</span> <span class="n">policy_checks</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">chk</span><span class="p">(</span><span class="n">pol</span><span class="p">):</span>
                    <span class="n">failures</span><span class="p">[</span><span class="n">pol</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strip_doc</span><span class="p">(</span><span class="n">chk</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;<span class="caps">ERROR</span>: Some policies failed sanity/safety checks:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pol_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">failures</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">pol_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">chk_str</span> <span class="ow">in</span> <span class="n">failures</span><span class="p">[</span><span class="n">pol_name</span><span class="p">]:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">chk_str</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;<span class="caps">OK</span>: All policies passed sanity/safety checks.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_policy_marked_for_op_first</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Policy includes a marked-for-op filter, but it is not the first filter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;filters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="s2">&quot;&#39;type&#39;: &#39;marked-for-op&#39;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">policy</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">policy</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;marked-for-op&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># first filter isn&#39;t even a dict; that&#39;s a failure</span>
            <span class="k">pass</span>
        <span class="c1"># fail - first filter isn&#39;t marked-for-op</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_check_policy_mark_but_no_tag_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Policy performs a mark action, but does not filter out resources already</span>
<span class="sd">        marked with that tag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;filters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="s1">&#39;actions&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">mark_tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">type</span><span class="p">({})):</span>
                <span class="c1"># not a dict, can&#39;t be a mark action</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;mark-for-op&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">mark_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">mark_tags</span><span class="p">:</span>
            <span class="n">tag_filter</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tag:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">:</span> <span class="s1">&#39;absent&#39;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">tag_filter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_generate_cleanup_policies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When c7n is run, it provisions all policies as lambda functions. But if</span>
<span class="sd">        policies are removed, it doesn&#39;t know how to clean them up. See</span>
<span class="sd">        https://github.com/capitalone/cloud-custodian/issues/48</span>

<span class="sd">        As a workaround for this, we tag all Lambda funcs created by c7n</span>
<span class="sd">        with Project: cloud-custodian and a Component tag of the policy name.</span>

<span class="sd">        This method generates policies that look for cloud-custodian Lambda</span>
<span class="sd">        functions and CloudWatch Events that aren&#39;t in the current list of</span>
<span class="sd">        policies, and therefore probably need cleanup, and notifies us.</span>

<span class="sd">        :param policies: list of policy dictionaries</span>
<span class="sd">        :type policies: list</span>
<span class="sd">        :return: list of c7n cleanup policies to add</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># base policies that just need filters added</span>
        <span class="n">lcleanup</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-cleanup-lambda&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Find and alert on orphaned c7n Lambda functions&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;The following cloud-custodian Lambda &#39;</span>
                                  <span class="s1">&#39;functions appear to be orphaned&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;and should probably be deleted&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="s1">&#39;[cloud-custodian {{ account }}] Orphaned &#39;</span>
                           <span class="s1">&#39;cloud-custodian Lambda funcs in {{ region }}&#39;</span><span class="p">,</span>
                <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;us@example.com&#39;</span><span class="p">]</span>
            <span class="p">}],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;tag:Project&#39;</span><span class="p">:</span> <span class="s1">&#39;cloud-custodian&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;tag:Component&#39;</span><span class="p">:</span> <span class="s1">&#39;present&#39;</span><span class="p">},</span>
                <span class="c1"># exclude itself...</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-cleanup-lambda&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-cleanup-cwe&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs_splunk_lambda&#39;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">cwecleanup</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-cleanup-cwe&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Find and alert on orphaned c7n CloudWatch Events&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;event-rule&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;The following cloud-custodian CloudWatch &#39;</span>
                                  <span class="s1">&#39;Event rules appear to be orphaned&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;and should probably be deleted&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="s1">&#39;[cloud-custodian {{ account }}] Orphaned &#39;</span>
                           <span class="s1">&#39;cloud-custodian <span class="caps">CW</span> Event rules in {{ region }}&#39;</span><span class="p">,</span>
                <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;us@example.com&#39;</span><span class="p">]</span>
            <span class="p">}],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;glob&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;custodian-*&#39;</span>
                <span class="p">},</span>
                <span class="c1"># exclude itself...</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;custodian-c7n-cleanup-lambda&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;custodian-c7n-cleanup-cwe&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs_splunk_lambda&#39;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="c1"># add the filters</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">cwecleanup</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;custodian-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="p">})</span>
            <span class="n">lcleanup</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">name</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">lcleanup</span><span class="p">,</span> <span class="n">cwecleanup</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_write_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;write a file - helper to make unit tests simpler&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_conf</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">policy</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="p">[])</span>
        <span class="c1"># set Lambda func &#39;Component&#39; tag to the policy name</span>
        <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;tags&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]:</span>
                <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">][</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">][</span><span class="s1">&#39;tags&#39;</span><span class="p">][</span><span class="s1">&#39;Component&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;actions&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">:</span>
            <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SPLUNK_SQS</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">conf</span>

    <span class="k">def</span> <span class="nf">_merge_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;merge update into base&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">kpath</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">kpath</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;periodic&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;periodic&#39;</span>
            <span class="p">):</span>
                <span class="c1"># short-circuit to not alter the &#39;mode&#39; top-level key on</span>
                <span class="c1"># policies if it isn&#39;t &quot;type: periodic&quot;</span>
                <span class="n">base</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">update</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
                <span class="n">base</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">type</span><span class="p">([])):</span>
                <span class="c1"># List / array</span>
                <span class="n">base</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_array_merge</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">,</span> <span class="n">kpath</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">type</span><span class="p">({})):</span>
                <span class="c1"># nested dictionary</span>
                <span class="n">base</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_conf</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">,</span> <span class="n">kpath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># not a dict or list; probably string or int, etc.</span>
                <span class="n">base</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c1"># remove actions if only specified in base (defaults)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="s1">&#39;actions&#39;</span> <span class="ow">in</span> <span class="n">base</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;actions&#39;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">base</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">base</span>

    <span class="k">def</span> <span class="nf">_array_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;this starts with update, and adds things from base&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="nb">type</span><span class="p">([])):</span>
            <span class="k">print</span><span class="p">(</span>
                <span class="s1">&#39;<span class="caps">ERROR</span>: policy has an array but defaults does not; cannot merge&#39;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Policy </span><span class="si">%s</span><span class="s1">: Cannot array merge non-array from defaults (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">policy_name</span><span class="p">,</span> <span class="n">base</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># find the defaults, by type</span>
        <span class="n">def_dicts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">type</span><span class="p">({})):</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
                    <span class="n">update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Do not know how to handle a defaults &#39;</span>
                                   <span class="s1">&#39;dict without a &quot;type&quot; key.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">def_dicts</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Defaults cannot specify multiple dicts &#39;</span>
                                   <span class="s1">&#39;with the same &quot;type&quot; in the same array!&#39;</span><span class="p">)</span>
            <span class="n">def_dicts</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c1"># do the updates</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">type</span><span class="p">({})):</span>
                <span class="k">continue</span>
            <span class="c1"># else it&#39;s a dict, update from defaults if present</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">def_dicts</span><span class="p">:</span>
                <span class="c1"># no defaults for this</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">def_dicts</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">i</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">del</span> <span class="n">def_dicts</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
        <span class="c1"># add any defaults that didn&#39;t already exist</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">def_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;notify&#39;</span><span class="p">:</span>
                <span class="c1"># Don&#39;t add notify actions to policies that don&#39;t have them</span>
                <span class="k">continue</span>
            <span class="n">update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">update</span>

    <span class="k">def</span> <span class="nf">_policy_rst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policies</span><span class="p">):</span>
        <span class="n">buildinfo</span> <span class="o">=</span> <span class="s1">&#39;by `</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> &lt;</span><span class="si">%s</span><span class="s1">&gt;`_&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;JOB_NAME&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BUILD_NUMBER&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BUILD_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">commit</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GIT_COMMIT&#39;</span><span class="p">]</span>
        <span class="n">gitlink</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">commit/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">REPO_HTML</span><span class="p">,</span> <span class="n">commit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">buildinfo</span> <span class="o">==</span> <span class="s1">&#39;by `  &lt;&gt;`_&#39;</span><span class="p">:</span>
            <span class="n">buildinfo</span> <span class="o">=</span> <span class="s1">&#39;locally&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;this page built </span><span class="si">%s</span><span class="s2"> from `</span><span class="si">%s</span><span class="s2"> &lt;</span><span class="si">%s</span><span class="s2">&gt;`_ at </span><span class="si">%s</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">buildinfo</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">gitlink</span><span class="p">,</span> <span class="n">timestr</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">policies</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">klink</span> <span class="o">=</span> <span class="s1">&#39;`</span><span class="si">%s</span><span class="s1"> &lt;</span><span class="si">%s</span><span class="s1">blob/</span><span class="si">%s</span><span class="s1">/policies/</span><span class="si">%s</span><span class="s1">.yml&gt;`_&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">REPO_HTML</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">k</span>
            <span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">klink</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_policy_comment</span><span class="p">(</span><span class="n">policies</span><span class="p">[</span><span class="n">k</span><span class="p">])])</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">tabulate</span><span class="p">(</span>
            <span class="n">rows</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Policy Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Description/Comment&#39;</span><span class="p">],</span>
            <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_policy_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">policy</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">policy</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>

    <span class="k">def</span> <span class="nf">_read_policies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;policies/&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yml&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_file_yaml</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;policies&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
            <span class="n">res</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;defaults&#39;</span> <span class="ow">and</span> <span class="n">y</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s1">&#39;<span class="caps">ERROR</span>: Policy file </span><span class="si">%s</span><span class="s1"> contains policy with name &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">f</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Loaded </span><span class="si">%d</span><span class="s1"> policies: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">res</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_read_file_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;unit test helper - return <span class="caps">YAML</span> from file contents&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">SafeLoader</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Exception loading <span class="caps">YAML</span>: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">raise</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">PolicyGen</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>


<h3 id="test_policygenpy"><a class="toclink" href="#test_policygenpy">test_policygen.py</a></h3>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Unit tests for policygen.py</span>

<span class="sd">To run:</span>

<span class="sd">1. ``virtualenv --python=python2.7 . &amp;&amp; source bin/activate``</span>
<span class="sd">2. ``pip install mock pytest==2.6.4 pytest-cov==1.8.1 coverage==3.7.1``</span>
<span class="sd">3. run:</span>

<span class="sd">    py.test -vv -s --cov-report term-missing --cov-report html \</span>
<span class="sd">    --cov=policygen.py --cov-config .coveragerc test_policygen.py</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">mock</span> <span class="kn">import</span> <span class="n">patch</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">mock_open</span><span class="p">,</span> <span class="n"><span class="caps">DEFAULT</span></span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">policygen</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">REPO_HTML</span> <span class="o">=</span> <span class="s1">&#39;https://github.com/example/custodian-config/&#39;</span>


<span class="k">class</span> <span class="nc">TestStripDoc</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_strip_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Testing</span>
<span class="sd">        the code to strip</span>
<span class="sd">        whitespace from</span>
<span class="sd">        docblocks.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;Testing the code to strip whitespace from docblocks.&#39;</span>
        <span class="k">assert</span> <span class="n">policygen</span><span class="o">.</span><span class="n">strip_doc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_strip_doc</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>


<span class="k">class</span> <span class="nc">TestApplyDefaults</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.PolicyGen._read_file_yaml&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">SPLUNK_SQS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Splunk&#39;</span><span class="p">:</span> <span class="s1">&#39;<span class="caps">SQS</span>&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">test_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.PolicyGen._read_file_yaml&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;queue_url&#39;</span><span class="p">:</span> <span class="s1">&#39;myurl&#39;</span><span class="p">}</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SPLUNK_SQS</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">][</span><span class="s1">&#39;queue&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;myurl&#39;</span>

    <span class="k">def</span> <span class="nf">test_apply_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;periodic&#39;</span><span class="p">,</span> <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">},</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_email&#39;</span><span class="p">:</span> <span class="s1">&#39;qemail&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_slack&#39;</span><span class="p">:</span> <span class="s1">&#39;qslack&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs&#39;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s1">&#39;resource-owner&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;me@example.com&#39;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="s1">&#39;my comments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;something&#39;</span><span class="p">:</span> <span class="s1">&#39;else&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;suspend&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span> <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;vdesc&#39;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="s1">&#39;my comments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;something&#39;</span><span class="p">:</span> <span class="s1">&#39;else&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;periodic&#39;</span><span class="p">,</span>
                <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Component&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;suspend&#39;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;vdesc&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_email&#39;</span><span class="p">:</span> <span class="s1">&#39;qemail&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_slack&#39;</span><span class="p">:</span> <span class="s1">&#39;qslack&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs&#39;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s1">&#39;resource-owner&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;me@example.com&#39;</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;Splunk&#39;</span><span class="p">:</span> <span class="s1">&#39;<span class="caps">SQS</span>&#39;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_apply_defaults</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_apply_defaults_implicit_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;periodic&#39;</span><span class="p">,</span> <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">},</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_email&#39;</span><span class="p">:</span> <span class="s1">&#39;qemail&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_slack&#39;</span><span class="p">:</span> <span class="s1">&#39;qslack&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs&#39;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s1">&#39;resource-owner&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;me@example.com&#39;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="s1">&#39;my comments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;something&#39;</span><span class="p">:</span> <span class="s1">&#39;else&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;suspend&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span> <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;vdesc&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}</span>
        <span class="p">}</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="s1">&#39;my comments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;something&#39;</span><span class="p">:</span> <span class="s1">&#39;else&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;periodic&#39;</span><span class="p">,</span>
                <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Component&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;suspend&#39;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;vdesc&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_email&#39;</span><span class="p">:</span> <span class="s1">&#39;qemail&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_slack&#39;</span><span class="p">:</span> <span class="s1">&#39;qslack&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs&#39;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s1">&#39;resource-owner&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;me@example.com&#39;</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;Splunk&#39;</span><span class="p">:</span> <span class="s1">&#39;<span class="caps">SQS</span>&#39;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_apply_defaults</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_apply_defaults_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;periodic&#39;</span><span class="p">,</span>
                <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Project&#39;</span><span class="p">:</span> <span class="s1">&#39;cloud-custodian&#39;</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_email&#39;</span><span class="p">:</span> <span class="s1">&#39;qemail&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_slack&#39;</span><span class="p">:</span> <span class="s1">&#39;qslack&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs&#39;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s1">&#39;resource-owner&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;me@example.com&#39;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="s1">&#39;my comments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;something&#39;</span><span class="p">:</span> <span class="s1">&#39;else&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;suspend&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span> <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;vdesc&#39;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="s1">&#39;my comments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;something&#39;</span><span class="p">:</span> <span class="s1">&#39;else&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;periodic&#39;</span><span class="p">,</span>
                <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Component&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;Project&#39;</span><span class="p">:</span> <span class="s1">&#39;cloud-custodian&#39;</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;suspend&#39;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;vdesc&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_email&#39;</span><span class="p">:</span> <span class="s1">&#39;qemail&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_slack&#39;</span><span class="p">:</span> <span class="s1">&#39;qslack&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs&#39;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s1">&#39;resource-owner&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;me@example.com&#39;</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;Splunk&#39;</span><span class="p">:</span> <span class="s1">&#39;<span class="caps">SQS</span>&#39;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_apply_defaults</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_apply_defaults_not_periodic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;periodic&#39;</span><span class="p">,</span>
                <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;rate(1 day)&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;blam&#39;</span><span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_email&#39;</span><span class="p">:</span> <span class="s1">&#39;qemail&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_slack&#39;</span><span class="p">:</span> <span class="s1">&#39;qslack&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs&#39;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s1">&#39;resource-owner&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;me@example.com&#39;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="s1">&#39;my comments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;something&#39;</span><span class="p">:</span> <span class="s1">&#39;else&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;suspend&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span> <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;vdesc&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="s1">&#39;my comments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;something&#39;</span><span class="p">:</span> <span class="s1">&#39;else&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
                <span class="s1">&#39;schedule&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;suspend&#39;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;vdesc&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_email&#39;</span><span class="p">:</span> <span class="s1">&#39;qemail&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;questions_slack&#39;</span><span class="p">:</span> <span class="s1">&#39;qslack&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs&#39;</span>
                    <span class="p">},</span>
                    <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s1">&#39;resource-owner&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;me@example.com&#39;</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;Splunk&#39;</span><span class="p">:</span> <span class="s1">&#39;<span class="caps">SQS</span>&#39;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_apply_defaults</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_apply_defaults_merge_call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.PolicyGen._merge_conf&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_apply_defaults</span><span class="p">({},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;pname&#39;</span><span class="p">})</span>
        <span class="k">assert</span> <span class="n">m</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;pname&#39;</span><span class="p">},</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">]</span>


<span class="k">class</span> <span class="nc">TestMergeConf</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_merge_conf_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">update</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;blam&#39;</span><span class="p">],</span> <span class="s1">&#39;blarg&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">}}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_merge_conf</span><span class="p">({},</span> <span class="n">update</span><span class="p">,</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">==</span> <span class="n">update</span>

    <span class="k">def</span> <span class="nf">test_merge_conf_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;blam&#39;</span><span class="p">}</span>
        <span class="n">update</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;newfoo&#39;</span><span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_merge_conf</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">==</span> <span class="p">{</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;newfoo&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;blam&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">test_merge_conf_no_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;blam&#39;</span><span class="p">}],</span> <span class="s1">&#39;blam&#39;</span><span class="p">:</span> <span class="s1">&#39;blarg&#39;</span><span class="p">}</span>
        <span class="n">update</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;newbar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;bazvalue&#39;</span><span class="p">}}</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;newbar&#39;</span><span class="p">,</span>
                <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;bazvalue&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;blam&#39;</span><span class="p">:</span> <span class="s1">&#39;blarg&#39;</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_merge_conf</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_merge_conf_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;barvalue&#39;</span><span class="p">,</span> <span class="s1">&#39;blam&#39;</span><span class="p">:</span> <span class="s1">&#39;blamvalue&#39;</span><span class="p">}}</span>
        <span class="n">update</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;newbar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;bazvalue&#39;</span><span class="p">}}</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;newbar&#39;</span><span class="p">,</span>
                <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;bazvalue&#39;</span><span class="p">,</span>
                <span class="s1">&#39;blam&#39;</span><span class="p">:</span> <span class="s1">&#39;blamvalue&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_merge_conf</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_merge_conf_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;myarr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mytype&#39;</span><span class="p">}]</span>
        <span class="p">}</span>
        <span class="n">update</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;bazvalue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;myarr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;bazvalue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;myarr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.PolicyGen._array_merge&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_am</span><span class="p">:</span>
            <span class="n">mock_am</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_merge_conf</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="n">expected</span>
        <span class="k">assert</span> <span class="n">mock_am</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span><span class="n">call</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mytype&#39;</span><span class="p">}],</span>
            <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">],</span>
            <span class="s1">&#39;pname&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="s1">&#39;myarr&#39;</span><span class="p">]</span>
        <span class="p">)]</span>


<span class="k">class</span> <span class="nc">TestArrayMerge</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_not_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;baz&#39;</span><span class="p">]]</span>
        <span class="n">update</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;baz&#39;</span><span class="p">],</span> <span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;baz&#39;</span><span class="p">],</span> <span class="s1">&#39;three&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;one&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_array_merge</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_dicts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;barvalue&#39;</span><span class="p">,</span> <span class="s1">&#39;extra&#39;</span><span class="p">:</span> <span class="s1">&#39;eval&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;extra&#39;</span><span class="p">:</span> <span class="s1">&#39;eval&#39;</span><span class="p">},</span>
            <span class="s1">&#39;blam&#39;</span><span class="p">,</span>
            <span class="s1">&#39;blarg&#39;</span>
        <span class="p">]</span>
        <span class="n">update</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;barupdate&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;blam&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;bazvalue&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span>
            <span class="s1">&#39;blam&#39;</span>
        <span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;barupdate&#39;</span><span class="p">,</span> <span class="s1">&#39;extra&#39;</span><span class="p">:</span> <span class="s1">&#39;eval&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;blam&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;bazvalue&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span>
            <span class="s1">&#39;blam&#39;</span><span class="p">,</span>
            <span class="s1">&#39;blarg&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;extra&#39;</span><span class="p">:</span> <span class="s1">&#39;eval&#39;</span><span class="p">}</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_array_merge</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="o">==</span> <span class="n">expected</span>

    <span class="k">def</span> <span class="nf">test_no_add_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ensure that _array_merge() doesn&#39;t add a notify action to policies</span>
        <span class="c1"># that don&#39;t have one</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">]}</span>
        <span class="p">]</span>
        <span class="n">update</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;blam&#39;</span><span class="p">:</span> <span class="s1">&#39;blarg&#39;</span><span class="p">}</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_array_merge</span><span class="p">(</span> <span class="n">base</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="p">[</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;blam&#39;</span><span class="p">:</span> <span class="s1">&#39;blarg&#39;</span><span class="p">}</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_base_dict_no_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}]</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_array_merge</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">test_base_multiple_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}</span>
        <span class="p">]</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_array_merge</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">test_base_not_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
        <span class="n">update</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_array_merge</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="s1">&#39;pname&#39;</span><span class="p">,</span> <span class="p">[])</span>


<span class="k">class</span> <span class="nc">TestWriteFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.open&#39;</span><span class="p">,</span> <span class="n">mock_open</span><span class="p">(),</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m_open</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_write_file</span><span class="p">(</span><span class="s1">&#39;fpath&#39;</span><span class="p">,</span> <span class="s1">&#39;fcontent&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">m_open</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="s1">&#39;fpath&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">(),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;fcontent&#39;</span><span class="p">),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="p">]</span>


<span class="k">class</span> <span class="nc">TestRun</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_simple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">se_apply_defaults</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">+defaults&#39;</span> <span class="o">%</span> <span class="n">policy</span>

        <span class="n">policies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;blam&#39;</span><span class="p">,</span>
            <span class="s1">&#39;defaults&#39;</span><span class="p">:</span> <span class="s1">&#39;quux&#39;</span>
        <span class="p">}</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">multiple</span><span class="p">(</span>
            <span class="s1">&#39;policygen.PolicyGen&#39;</span><span class="p">,</span>
            <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">_read_policies</span><span class="o">=</span><span class="n"><span class="caps">DEFAULT</span></span><span class="p">,</span>
            <span class="n">_apply_defaults</span><span class="o">=</span><span class="n"><span class="caps">DEFAULT</span></span><span class="p">,</span>
            <span class="n">_policy_rst</span><span class="o">=</span><span class="n"><span class="caps">DEFAULT</span></span><span class="p">,</span>
            <span class="n">_write_file</span><span class="o">=</span><span class="n"><span class="caps">DEFAULT</span></span><span class="p">,</span>
            <span class="n">_generate_cleanup_policies</span><span class="o">=</span><span class="n"><span class="caps">DEFAULT</span></span><span class="p">,</span>
            <span class="n">_check_policies</span><span class="o">=</span><span class="n"><span class="caps">DEFAULT</span></span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">mocks</span><span class="p">:</span>
            <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_read_policies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">policies</span>
            <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_apply_defaults&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">se_apply_defaults</span>
            <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_policy_rst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">&#39;polMD&#39;</span>
            <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_generate_cleanup_policies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;cleanup1&#39;</span><span class="p">,</span> <span class="s1">&#39;cleanup2&#39;</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_read_policies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span><span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_apply_defaults&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s1">&#39;quux&#39;</span><span class="p">,</span> <span class="s1">&#39;blam&#39;</span><span class="p">),</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s1">&#39;quux&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">),</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s1">&#39;quux&#39;</span><span class="p">,</span> <span class="s1">&#39;cleanup1&#39;</span><span class="p">),</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s1">&#39;quux&#39;</span><span class="p">,</span> <span class="s1">&#39;cleanup2&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_generate_cleanup_policies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;blam+defaults&#39;</span><span class="p">,</span> <span class="s1">&#39;bar+defaults&#39;</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_policy_rst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">policies</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_write_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s1">&#39;custodian.yml&#39;</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;policies&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;blam+defaults&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;bar+defaults&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;cleanup1+defaults&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;cleanup2+defaults&#39;</span>
                <span class="p">]}</span>
            <span class="p">)),</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s1">&#39;policies.rst&#39;</span><span class="p">,</span> <span class="s1">&#39;polMD&#39;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_check_policies&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="s1">&#39;blam+defaults&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;bar+defaults&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;cleanup1+defaults&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;cleanup2+defaults&#39;</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>


<span class="k">class</span> <span class="nc">TestCheckPolicies</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capsys</span><span class="p">):</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;blam&#39;</span><span class="p">}</span>
        <span class="p">]</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">multiple</span><span class="p">(</span>
            <span class="s1">&#39;policygen.PolicyGen&#39;</span><span class="p">,</span>
            <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">_check_policy_marked_for_op_first</span><span class="o">=</span><span class="n"><span class="caps">DEFAULT</span></span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">mocks</span><span class="p">:</span>
            <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_check_policy_marked_for_op_first&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policies</span><span class="p">(</span><span class="n">policies</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_check_policy_marked_for_op_first&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">policies</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">policies</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="n">expected_out</span> <span class="o">=</span> <span class="s1">&#39;<span class="caps">OK</span>: All policies passed sanity/safety checks.&#39;</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">capsys</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">err</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">expected_out</span>

    <span class="k">def</span> <span class="nf">test_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capsys</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">se_strip_doc</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">name</span>

        <span class="n">policies</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;blam&#39;</span><span class="p">}</span>
        <span class="p">]</span>
        <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">multiple</span><span class="p">(</span>
            <span class="s1">&#39;policygen.PolicyGen&#39;</span><span class="p">,</span>
            <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">_check_policy_marked_for_op_first</span><span class="o">=</span><span class="n"><span class="caps">DEFAULT</span></span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">mocks</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.strip_doc&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_sd</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mocks</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">mocks</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_check_policy_marked_for_op_first&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">mock_sd</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">se_strip_doc</span>
                <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">SystemExit</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policies</span><span class="p">(</span><span class="n">policies</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">ex</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">mocks</span><span class="p">[</span><span class="s1">&#39;_check_policy_marked_for_op_first&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">policies</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">policies</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="n">expected_out</span> <span class="o">=</span> <span class="s2">&quot;<span class="caps">ERROR</span>: Some policies failed sanity/safety checks:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">expected_out</span> <span class="o">+=</span> <span class="s2">&quot;baz</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">expected_out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;_check_policy_marked_for_op_first</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">expected_out</span> <span class="o">+=</span> <span class="s2">&quot;foo</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">expected_out</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">_check_policy_marked_for_op_first</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">capsys</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">err</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">out</span> <span class="o">==</span> <span class="n">expected_out</span>


<span class="k">class</span> <span class="nc">TestCheckPolicyMarkedForOpFirst</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_no_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mark&#39;</span><span class="p">]}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_marked_for_op_first</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_no_marked_for_op</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mark&#39;</span><span class="p">],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;alive&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;tag:foo&#39;</span><span class="p">:</span> <span class="s1">&#39;present&#39;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_marked_for_op_first</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_marked_for_op_first</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mark&#39;</span><span class="p">],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;marked-for-op&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span>
                <span class="p">},</span>
                <span class="s1">&#39;alive&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;tag:foo&#39;</span><span class="p">:</span> <span class="s1">&#39;present&#39;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_marked_for_op_first</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_marked_for_op_not_first</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mark&#39;</span><span class="p">],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;alive&#39;</span><span class="p">,</span>
                <span class="p">{</span><span class="s1">&#39;tag:foo&#39;</span><span class="p">:</span> <span class="s1">&#39;present&#39;</span><span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;marked-for-op&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_marked_for_op_first</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">test_marked_for_op_nested</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mark&#39;</span><span class="p">],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;or&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s1">&#39;tag:foo&#39;</span><span class="p">:</span> <span class="s1">&#39;present&#39;</span><span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;marked-for-op&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span>
                        <span class="p">},</span>
                        <span class="s1">&#39;alive&#39;</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_marked_for_op_first</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span>


<span class="k">class</span> <span class="nc">TestCheckPolicyMarkButNoTagFilter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_no_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mark&#39;</span><span class="p">]}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_mark_but_no_tag_filter</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_no_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_mark_but_no_tag_filter</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_no_mark_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;stop&#39;</span><span class="p">]}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_mark_but_no_tag_filter</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_one_mark_action_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mark-for-op&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-mytag&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;foo-mark {op}@{action_date}&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">7</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Instances&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value_type&#39;</span><span class="p">:</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;less-than&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;tag:c7n-mytag&#39;</span><span class="p">:</span> <span class="s1">&#39;absent&#39;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_mark_but_no_tag_filter</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_two_mark_actions_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mark-for-op&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-mytag&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;foo-mark {op}@{action_date}&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">7</span>
                <span class="p">},</span>
                <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mark-for-op&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-foobar&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;foobar-mark {op}@{action_date}&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">14</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Instances&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value_type&#39;</span><span class="p">:</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;less-than&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;tag:c7n-mytag&#39;</span><span class="p">:</span> <span class="s1">&#39;absent&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;tag:c7n-foobar&#39;</span><span class="p">:</span> <span class="s1">&#39;absent&#39;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_mark_but_no_tag_filter</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_one_mark_action_no_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mark-for-op&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-mytag&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;foo-mark {op}@{action_date}&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">7</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;tag:c7n-NOTmytag&#39;</span><span class="p">:</span> <span class="s1">&#39;absent&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Instances&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value_type&#39;</span><span class="p">:</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;less-than&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_mark_but_no_tag_filter</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">test_two_mark_actions_one_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mark-for-op&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-mytag&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;foo-mark {op}@{action_date}&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">7</span>
                <span class="p">},</span>
                <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mark-for-op&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-foobar&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;foobar-mark {op}@{action_date}&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">14</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Instances&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value_type&#39;</span><span class="p">:</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;less-than&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;tag:c7n-NOTmytag&#39;</span><span class="p">:</span> <span class="s1">&#39;absent&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;tag:c7n-foobar&#39;</span><span class="p">:</span> <span class="s1">&#39;absent&#39;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_mark_but_no_tag_filter</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">test_two_mark_actions_no_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mark-for-op&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-mytag&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;foo-mark {op}@{action_date}&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">7</span>
                <span class="p">},</span>
                <span class="s1">&#39;stop&#39;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;mark-for-op&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-foobar&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;foobar-mark {op}@{action_date}&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">14</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Instances&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value_type&#39;</span><span class="p">:</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;less-than&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;tag:c7n-NOTmytag&#39;</span><span class="p">:</span> <span class="s1">&#39;absent&#39;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_check_policy_mark_but_no_tag_filter</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span>


<span class="k">class</span> <span class="nc">TestGenerateCleanupPolicies</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lcleanup</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-cleanup-lambda&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Find and alert on orphaned c7n Lambda functions&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;The following cloud-custodian Lambda &#39;</span>
                                  <span class="s1">&#39;functions appear to be orphaned&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;and should probably be deleted&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="s1">&#39;[cloud-custodian {{ account }}] Orphaned &#39;</span>
                           <span class="s1">&#39;cloud-custodian Lambda funcs in {{ region }}&#39;</span><span class="p">,</span>
                <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;us@example.com&#39;</span><span class="p">]</span>
            <span class="p">}],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;tag:Project&#39;</span><span class="p">:</span> <span class="s1">&#39;cloud-custodian&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;tag:Component&#39;</span><span class="p">:</span> <span class="s1">&#39;present&#39;</span><span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-cleanup-lambda&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-cleanup-cwe&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs_splunk_lambda&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">cwecleanup</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;c7n-cleanup-cwe&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Find and alert on orphaned c7n CloudWatch Events&#39;</span><span class="p">,</span>
            <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;event-rule&#39;</span><span class="p">,</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;notify&#39;</span><span class="p">,</span>
                <span class="s1">&#39;violation_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;The following cloud-custodian CloudWatch &#39;</span>
                                  <span class="s1">&#39;Event rules appear to be orphaned&#39;</span><span class="p">,</span>
                <span class="s1">&#39;action_desc&#39;</span><span class="p">:</span> <span class="s1">&#39;and should probably be deleted&#39;</span><span class="p">,</span>
                <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="s1">&#39;[cloud-custodian {{ account }}] Orphaned &#39;</span>
                           <span class="s1">&#39;cloud-custodian <span class="caps">CW</span> Event rules in {{ region }}&#39;</span><span class="p">,</span>
                <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;us@example.com&#39;</span><span class="p">]</span>
            <span class="p">}],</span>
            <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;glob&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;custodian-*&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;custodian-c7n-cleanup-lambda&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;custodian-c7n-cleanup-cwe&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Component&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs_splunk_lambda&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;custodian-foo&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;custodian-bar&#39;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;custodian-baz&#39;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;periodic&#39;</span><span class="p">},</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;periodic&#39;</span><span class="p">},</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">}</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_generate_cleanup_policies</span><span class="p">(</span><span class="n">policies</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">lcleanup</span><span class="p">,</span> <span class="n">cwecleanup</span>
        <span class="p">]</span>


<span class="k">class</span> <span class="nc">TestPolicyRst</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_rst_jenkins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">se_comment</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-comment&#39;</span> <span class="o">%</span> <span class="n">policy</span>

        <span class="n">policies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;blam&#39;</span>
        <span class="p">}</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="s1">&#39;someTime&#39;</span>
        <span class="n">gitlink</span> <span class="o">=</span> <span class="n">REPO_HTML</span> <span class="o">+</span> <span class="s1">&#39;commit/&#39;</span> <span class="o">+</span> <span class="s1">&#39;abcd1234&#39;</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;this page built by `custodian-config/foo 2 &quot;</span> \
            <span class="s2">&quot;&lt;https://jenkins/job/2&gt;`_ from `abcd1234 &lt;</span><span class="si">%s</span><span class="s2">&gt;`_ at </span><span class="si">%s</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">gitlink</span><span class="p">,</span> <span class="n">timestr</span>
            <span class="p">)</span>
        <span class="n">expected</span> <span class="o">+=</span> <span class="s2">&quot;tableHere&quot;</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.PolicyGen._policy_comment&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">se_comment</span>
            <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;GIT_COMMIT&#39;</span><span class="p">:</span> <span class="s1">&#39;abcd1234&#39;</span><span class="p">,</span>
                <span class="s1">&#39;BUILD_NUMBER&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                <span class="s1">&#39;JOB_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;custodian-config/foo&#39;</span><span class="p">,</span>
                <span class="s1">&#39;BUILD_URL&#39;</span><span class="p">:</span> <span class="s1">&#39;https://jenkins/job/2&#39;</span>
            <span class="p">},</span> <span class="n">clear</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.timestr&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m_timestr</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.tabulate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m_tabulate</span><span class="p">:</span>
                        <span class="n">m_tabulate</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">&#39;tableHere&#39;</span>
                        <span class="n">m_timestr</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">timestr</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_policy_rst</span><span class="p">(</span><span class="n">policies</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="n">expected</span>
        <span class="k">assert</span> <span class="n">m_tabulate</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s1">&#39;`baz &lt;</span><span class="si">%s</span><span class="s1">blob/abcd1234/policies/baz.yml&gt;`_&#39;</span> <span class="o">%</span> <span class="n">REPO_HTML</span><span class="p">,</span>
                        <span class="s1">&#39;blam-comment&#39;</span>
                    <span class="p">],</span>
                    <span class="p">[</span>
                        <span class="s1">&#39;`foo &lt;</span><span class="si">%s</span><span class="s1">blob/abcd1234/policies/foo.yml&gt;`_&#39;</span> <span class="o">%</span> <span class="n">REPO_HTML</span><span class="p">,</span>
                        <span class="s1">&#39;bar-comment&#39;</span>
                    <span class="p">]</span>
                <span class="p">],</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Policy Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Description/Comment&#39;</span><span class="p">],</span>
                <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_rst_local</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">se_comment</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-comment&#39;</span> <span class="o">%</span> <span class="n">policy</span>

        <span class="n">policies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="s1">&#39;baz&#39;</span><span class="p">:</span> <span class="s1">&#39;blam&#39;</span>
        <span class="p">}</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="s1">&#39;someTime&#39;</span>
        <span class="n">gitlink</span> <span class="o">=</span> <span class="n">REPO_HTML</span> <span class="o">+</span> <span class="s1">&#39;commit/&#39;</span> <span class="o">+</span> <span class="s1">&#39;abcd1234&#39;</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;this page built locally from `abcd1234 &lt;</span><span class="si">%s</span><span class="s2">&gt;`_ at </span><span class="si">%s</span><span class="s2">&quot;</span> \
            <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gitlink</span><span class="p">,</span> <span class="n">timestr</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">+=</span> <span class="s2">&quot;tableHere&quot;</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.PolicyGen._policy_comment&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">se_comment</span>
            <span class="k">with</span> <span class="n">patch</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="p">{</span>
                <span class="s1">&#39;GIT_COMMIT&#39;</span><span class="p">:</span> <span class="s1">&#39;abcd1234&#39;</span>
            <span class="p">},</span> <span class="n">clear</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.timestr&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m_timestr</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.tabulate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">m_tabulate</span><span class="p">:</span>
                        <span class="n">m_tabulate</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">&#39;tableHere&#39;</span>
                        <span class="n">m_timestr</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">timestr</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_policy_rst</span><span class="p">(</span><span class="n">policies</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="n">expected</span>
        <span class="k">assert</span> <span class="n">m_tabulate</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s1">&#39;`baz &lt;</span><span class="si">%s</span><span class="s1">blob/abcd1234/policies/baz.yml&gt;`_&#39;</span> <span class="o">%</span> <span class="n">REPO_HTML</span><span class="p">,</span>
                        <span class="s1">&#39;blam-comment&#39;</span>
                    <span class="p">],</span>
                    <span class="p">[</span>
                        <span class="s1">&#39;`foo &lt;</span><span class="si">%s</span><span class="s1">blob/abcd1234/policies/foo.yml&gt;`_&#39;</span> <span class="o">%</span> <span class="n">REPO_HTML</span><span class="p">,</span>
                        <span class="s1">&#39;bar-comment&#39;</span>
                    <span class="p">]</span>
                <span class="p">],</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Policy Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Description/Comment&#39;</span><span class="p">],</span>
                <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span>
            <span class="p">)</span>
        <span class="p">]</span>


<span class="k">class</span> <span class="nc">TestPolicyComment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;mycomment&#39;</span><span class="p">,</span>
            <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="s1">&#39;mycomments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;mydescription&#39;</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_policy_comment</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;mycomment&#39;</span>

    <span class="k">def</span> <span class="nf">test_comments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;comments&#39;</span><span class="p">:</span> <span class="s1">&#39;mycomments&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;mydescription&#39;</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_policy_comment</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;mycomments&#39;</span>

    <span class="k">def</span> <span class="nf">test_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;mydescription&#39;</span>
        <span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_policy_comment</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;mydescription&#39;</span>

    <span class="k">def</span> <span class="nf">test_none</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_policy_comment</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span>


<span class="k">class</span> <span class="nc">TestReadPolicies</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">se_read</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">fpath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>

        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.os.listdir&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_list</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
                <span class="s1">&#39;policygen.PolicyGen._read_file_yaml&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">mock_read</span><span class="p">:</span>
                <span class="n">mock_list</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;foo.yml&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;bar.yml&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;defaults.yml&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;<span class="caps">README</span>.md&#39;</span>
                <span class="p">]</span>
                <span class="n">mock_read</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">se_read</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_read_policies</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="p">{</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="s1">&#39;policies/foo.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">},</span>
            <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="s1">&#39;policies/bar.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">},</span>
            <span class="s1">&#39;defaults&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="s1">&#39;policies/defaults.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;defaults&#39;</span><span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">test_read_bad_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">se_read</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">fpath</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">fpath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;wrongName&#39;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">fpath</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>

        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.os.listdir&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_list</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">patch</span><span class="p">(</span>
                <span class="s1">&#39;policygen.PolicyGen._read_file_yaml&#39;</span><span class="p">,</span> <span class="n">autospec</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">mock_read</span><span class="p">:</span>
                <span class="n">mock_list</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;foo.yml&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;bar.yml&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;defaults.yml&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;<span class="caps">README</span>.md&#39;</span>
                <span class="p">]</span>
                <span class="n">mock_read</span><span class="o">.</span><span class="n">side_effect</span> <span class="o">=</span> <span class="n">se_read</span>
                <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_read_policies</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">ex</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">message</span> <span class="o">==</span> <span class="s1">&#39;<span class="caps">ERROR</span>: Policy file foo.yml contains &#39;</span> \
            <span class="s1">&#39;policy with name &quot;wrongName&quot;.&#39;</span>


<span class="k">class</span> <span class="nc">TestReadFileYaml</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">policygen</span><span class="o">.</span><span class="n">PolicyGen</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="s2">&quot;- foo</span><span class="se">\n</span><span class="s2">- bar</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.open&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m_open</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_read_file_yaml</span><span class="p">(</span><span class="s1">&#39;/foo/bar.yml&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">m_open</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="s1">&#39;/foo/bar.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">(),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="s2">&quot;- foo</span><span class="se">\n</span><span class="s2">- bar</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.open&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m_open</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_read_file_yaml</span><span class="p">(</span><span class="s1">&#39;/foo/bar.yml&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">res</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">m_open</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="s1">&#39;/foo/bar.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">(),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_read_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">read_data</span><span class="o">=</span><span class="s2">&quot;  - foo:</span><span class="se">\n</span><span class="s2">- bar&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">patch</span><span class="p">(</span><span class="s1">&#39;policygen.open&#39;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">m_open</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">_read_file_yaml</span><span class="p">(</span><span class="s1">&#39;/foo/bar.yml&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">m_open</span><span class="o">.</span><span class="n">mock_calls</span> <span class="o">==</span> <span class="p">[</span>
            <span class="n">call</span><span class="p">(</span><span class="s1">&#39;/foo/bar.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">(),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
            <span class="n">call</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="p">]</span>
</pre></div>


<h3 id="errorscanpy"><a class="toclink" href="#errorscanpy">errorscan.py</a></h3>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Script to scan CloudWatch metrics and Dead Letter <span class="caps">SQS</span> queue for all</span>
<span class="sd">cloud-custodian lambda functions, and print info and logs and exit non-zero if</span>
<span class="sd">any failed or errored.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">botocore.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">tzinfo</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n"><span class="caps">FORMAT</span></span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2">] </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n"><span class="caps">WARNING</span></span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="n"><span class="caps">FORMAT</span></span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

<span class="c1"># suppress boto3 internal logging below <span class="caps">WARNING</span> level</span>
<span class="n">boto3_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;boto3&quot;</span><span class="p">)</span>
<span class="n">boto3_log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n"><span class="caps">WARNING</span></span><span class="p">)</span>
<span class="n">boto3_log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># suppress botocore internal logging below <span class="caps">WARNING</span> level</span>
<span class="n">botocore_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;botocore&quot;</span><span class="p">)</span>
<span class="n">botocore_log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n"><span class="caps">WARNING</span></span><span class="p">)</span>
<span class="n">botocore_log</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># Override max attempts for botocore retry configuration, to cope with</span>
<span class="c1"># throttling. This  constant is used in two different places below...</span>
<span class="n">BOTOCORE_MAX_ATTEMPTS</span> <span class="o">=</span> <span class="mi">10</span>

<span class="k">def</span> <span class="nf">red</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the given string (``s``) surrounded by the <span class="caps">ANSI</span> escape codes to</span>
<span class="sd">    print it in red.</span>
<span class="sd">    :param s: string to console-color red</span>
<span class="sd">    :type s: str</span>
<span class="sd">    :returns: s surrounded by <span class="caps">ANSI</span> color escapes for red text</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0;31m&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>


<span class="k">def</span> <span class="nf">green</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the given string (``s``) surrounded by the <span class="caps">ANSI</span> escape codes to</span>
<span class="sd">    print it in green.</span>
<span class="sd">    :param s: string to console-color green</span>
<span class="sd">    :type s: str</span>
<span class="sd">    :returns: s surrounded by <span class="caps">ANSI</span> color escapes for green text</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0;32m&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>


<span class="k">class</span> <span class="nc"><span class="caps">UTC</span></span><span class="p">(</span><span class="n">tzinfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;<span class="caps">UTC</span>&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">utcoffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tzname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;<span class="caps">UTC</span>&quot;</span>

    <span class="k">def</span> <span class="nf">dst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LambdaHealthChecker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class for checking Lambda func health via CloudWatch&quot;&quot;&quot;</span>

    <span class="n">req_id_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;^(<span class="caps">START</span>|<span class="caps">END</span>|<span class="caps">REPORT</span>|\S+\s\S+)\s&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}).*&#39;</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cw</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize LambdaHealthChecker</span>

<span class="sd">        :param func_name: Lambda function name</span>
<span class="sd">        :type func_name: str</span>
<span class="sd">        :param logs: boto3 &quot;logs&quot; service client, or None to create new</span>
<span class="sd">        :type logs: boto3.client</span>
<span class="sd">        :param cw: boto3 &quot;cloudwatch&quot; Service Resource, or None to create new</span>
<span class="sd">        :type cw: boto3.resource</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func_name</span> <span class="o">=</span> <span class="n">func_name</span>
        <span class="k">if</span> <span class="n">logs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># override default max_attempts from 5 to 10, for throttling</span>
            <span class="n">retry_conf</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_attempts&#39;</span><span class="p">:</span> <span class="n">BOTOCORE_MAX_ATTEMPTS</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logs</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">retry_conf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logs</span> <span class="o">=</span> <span class="n">logs</span>
        <span class="k">if</span> <span class="n">cw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;cloudwatch&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span> <span class="o">=</span> <span class="n">cw</span>

    <span class="k">def</span> <span class="nf">get_filtered_logs</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">request_ids</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span> <span class="n">group_name</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get CloudWatch logs for the last ``interval`` seconds and return only</span>
<span class="sd">        those entries with messages matching ``filter_re``.</span>

<span class="sd">        :param request_ids: list of str request IDs to get logs for</span>
<span class="sd">        :type request_ids: list</span>
<span class="sd">        :param group_name: CloudWatch logs group name. If left at default of</span>
<span class="sd">          ``None``, defaults to ``/aws/lambda/{func_name}``.</span>
<span class="sd">        :type group_name: str</span>
<span class="sd">        :param interval: how far back in logs to look, in seconds</span>
<span class="sd">        :type interval: int</span>
<span class="sd">        :return: dict of request_id to list of log entry dicts</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cloudwatch_logs</span><span class="p">(</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">group_name</span><span class="o">=</span><span class="n">group_name</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="s1">&#39;/aws/lambda/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_name</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">matchcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req_id_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;Event </span><span class="si">%s</span><span class="s1"> in group </span><span class="si">%s</span><span class="s1"> stream </span><span class="si">%s</span><span class="s1"> does not match &#39;</span>
                    <span class="s1">&#39;RequestId regex: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">log</span><span class="p">[</span><span class="s1">&#39;eventId&#39;</span><span class="p">],</span> <span class="n">group_name</span><span class="p">,</span>
                    <span class="n">log</span><span class="p">[</span><span class="s1">&#39;logStreamName&#39;</span><span class="p">],</span> <span class="n">log</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">req_id</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># logger.debug(&quot;RequestID: %s Message: %s&quot;, req_id, log[&#39;message&#39;])</span>
            <span class="k">if</span> <span class="n">req_id</span> <span class="ow">in</span> <span class="n">request_ids</span><span class="p">:</span>
                <span class="n">log</span><span class="p">[</span><span class="s1">&#39;logGroupName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_name</span>
                <span class="k">if</span> <span class="n">req_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">result</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                <span class="n">matchcount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Filtered </span><span class="si">%d</span><span class="s1"> log messages to </span><span class="si">%d</span><span class="s1"> messages from </span><span class="si">%d</span><span class="s1"> invocations&#39;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">),</span> <span class="n">matchcount</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_cloudwatch_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span> <span class="n">group_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get CloudWatch logs for the last ``interval`` seconds. The log group</span>
<span class="sd">        name defaults to ``/aws/lambda/{func_name}`` if left at the default of</span>
<span class="sd">        None.</span>

<span class="sd">        :param group_name: CloudWatch logs group name. If left at default of</span>
<span class="sd">          ``None``, defaults to ``/aws/lambda/{func_name}``.</span>
<span class="sd">        :type group_name: str</span>
<span class="sd">        :param interval: how far back in logs to look, in seconds</span>
<span class="sd">        :type interval: int</span>
<span class="sd">        :return: list of log entry dicts, sorted by timestamp</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># milliseconds</span>
        <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">interval</span>
        <span class="k">if</span> <span class="n">group_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="s1">&#39;/aws/lambda/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_name</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Finding streams in <span class="caps">CW</span> Log Group: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)</span>
        <span class="n">paginator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logs</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s1">&#39;describe_log_streams&#39;</span><span class="p">)</span>
        <span class="n">stream_iterator</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span>
            <span class="n">logGroupName</span><span class="o">=</span><span class="n">group_name</span><span class="p">,</span>
            <span class="n">orderBy</span><span class="o">=</span><span class="s1">&#39;LastEventTime&#39;</span><span class="p">,</span>
            <span class="n">descending</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)</span>
        <span class="n">streams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">resp</span> <span class="ow">in</span> <span class="n">stream_iterator</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;logStreams&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">stream</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lastEventTimestamp&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">streams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stream</span><span class="p">[</span><span class="s1">&#39;logStreamName&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">):</span>
                <span class="n">emsg</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Code&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">emsg</span> <span class="o">==</span> <span class="s1">&#39;ResourceNotFoundException&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;CloudWatch Log group does not exist: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                                   <span class="n">group_name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">[]</span>
            <span class="k">raise</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">%d</span><span class="s1"> log streams with events in time span&#39;</span><span class="p">,</span>
                     <span class="nb">len</span><span class="p">(</span><span class="n">streams</span><span class="p">))</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sname</span> <span class="ow">in</span> <span class="n">streams</span><span class="p">:</span>
            <span class="n">logs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_cw_log_stream</span><span class="p">(</span>
                <span class="n">group_name</span><span class="p">,</span>
                <span class="n">sname</span><span class="p">,</span>
                <span class="n">cutoff</span><span class="p">,</span>
                <span class="n">now</span>
            <span class="p">))</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_cw_log_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">start_ts</span><span class="p">,</span> <span class="n">end_ts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all log messages from the specified stream at or after ``ts``.</span>

<span class="sd">        :param group_name: CloudWatch log group name</span>
<span class="sd">        :type group_name: str</span>
<span class="sd">        :param stream_name: CloudWatch log stream name</span>
<span class="sd">        :type stream_name: str</span>
<span class="sd">        :param start_ts: timestamp in milliseconds to return logs after</span>
<span class="sd">        :type start_ts: int</span>
<span class="sd">        :param end_ts: timestamp in milliseconds to return logs before</span>
<span class="sd">        :type end_ts: int</span>
<span class="sd">        :return:</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Getting events from CloudWatch Logs Group </span><span class="si">%s</span><span class="s1"> stream </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                     <span class="n">group_name</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
        <span class="n">paginator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logs</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s1">&#39;filter_log_events&#39;</span><span class="p">)</span>
        <span class="n">resp_iter</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span>
            <span class="n">logGroupName</span><span class="o">=</span><span class="n">group_name</span><span class="p">,</span>
            <span class="n">logStreamNames</span><span class="o">=</span><span class="p">[</span><span class="n">stream_name</span><span class="p">],</span>
            <span class="n">startTime</span><span class="o">=</span><span class="n">start_ts</span><span class="p">,</span>
            <span class="n">endTime</span><span class="o">=</span><span class="n">end_ts</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">resp</span> <span class="ow">in</span> <span class="n">resp_iter</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">%d</span><span class="s1"> messages in stream </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                     <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">),</span> <span class="n">stream_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">messages</span>

    <span class="k">def</span> <span class="nf">get_cloudwatch_metric_sums</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">86400</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dict of CloudWatch Metrics for this Lambda function, summed</span>
<span class="sd">        over ``interval``. Keys are metric names (&quot;Errors&quot;, &quot;Throttles&quot;,</span>
<span class="sd">        &quot;Invocations&quot;) and values are sums of each ``period``-period datapoint,</span>
<span class="sd">        for the past ``interval`` seconds.</span>

<span class="sd">        For further information on these metrics, see:</span>
<span class="sd">        https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/</span>
<span class="sd">        lam-metricscollected.html</span>

<span class="sd">        :param interval: how many seconds of historical data to request</span>
<span class="sd">        :type interval: int</span>
<span class="sd">        :param period: the metric collection period to request from CloudWatch</span>
<span class="sd">        :type period: int</span>
<span class="sd">        :return: dict of metric name to sum for the last ``interval`` seconds</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Errors&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;Throttles&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;Invocations&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n"><span class="caps">UTC</span></span><span class="p">())</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Checking CloudWatch Metrics for Lambda function: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_func_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Namespace</span><span class="o">=</span><span class="s1">&#39;<span class="caps">AWS</span>/Lambda&#39;</span><span class="p">,</span>
            <span class="n">Dimensions</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;FunctionName&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_name</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">):</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="n">_name_value_dict</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
            <span class="c1"># Lambda metrics are published twice, once with just</span>
            <span class="c1"># FunctionName, and a second time with both FunctionName and</span>
            <span class="c1"># Resource. Skip the duplicates that also have Resource dimension.</span>
            <span class="k">if</span> <span class="n">dims</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;FunctionName&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">(</span>
                <span class="n">Dimensions</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;FunctionName&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_name</span><span class="p">}],</span>
                <span class="n">StartTime</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                <span class="n">EndTime</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
                <span class="n">Period</span><span class="o">=</span><span class="n">period</span><span class="p">,</span>
                <span class="n">Statistics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Sum&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Sum&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;Datapoints&#39;</span><span class="p">]])</span>
            <span class="n">res</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Metrics for </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_name</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_matching_func_names</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of all Lambda functions with names that either start</span>
<span class="sd">        with ``filter`` (if ``filter`` is a string) or match ``filter`` (if</span>
<span class="sd">        filter is a :py:class:`re.RegexObject`).</span>

<span class="sd">        :param filter: lambda function name filter</span>
<span class="sd">        :type filter: ``str`` or :py:class:`re.RegexObject`</span>
<span class="sd">        :param client: boto3 Lambda client, or None to create new</span>
<span class="sd">        :type client: boto3.client</span>
<span class="sd">        :return: list of matching Lambda function names</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">client</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;lambda&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)):</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Finding Lambda function names matching: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">.</span><span class="n">pattern</span>
        <span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">paginator</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s1">&#39;list_functions&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Functions&#39;</span><span class="p">]:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">filter</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;FunctionName&#39;</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="n">matches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">[</span><span class="s1">&#39;FunctionName&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Matched </span><span class="si">%d</span><span class="s1"> of </span><span class="si">%d</span><span class="s1"> Lambda functions&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span> <span class="n">total</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CustodianErrorReporter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scan and report on <span class="caps">CW</span> Metrics/Logs errors for c7n lambdas&quot;&quot;&quot;</span>

    <span class="c1">#: How far to look back in logs and metrics, in seconds</span>
    <span class="n"><span class="caps">INTERVAL</span></span> <span class="o">=</span> <span class="mi">86400</span>

    <span class="c1">#: Human-readable description of the interval</span>
    <span class="n">INVL_DESC</span> <span class="o">=</span> <span class="s1">&#39;day&#39;</span>

    <span class="c1">#: What period to request CloudWatch metrics for</span>
    <span class="n">METRIC_PERIOD</span> <span class="o">=</span> <span class="mi">86400</span>

    <span class="c1">#: Amount of time (float seconds) to sleep between checking each function,</span>
    <span class="c1">#: to try to avoid <span class="caps">API</span> rate limiting.</span>
    <span class="n">INTER_FUNC_SLEEP</span> <span class="o">=</span> <span class="mf">3.0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dlq_arn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dlq_arn</span> <span class="o">=</span> <span class="n">dlq_arn</span>
        <span class="c1"># override default max_attempts from 5 to 10, for throttling</span>
        <span class="n">retry_conf</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_attempts&#39;</span><span class="p">:</span> <span class="n">BOTOCORE_MAX_ATTEMPTS</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logs</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">retry_conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;cloudwatch&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lambda</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;lambda&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sqs</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;sqs&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n"><span class="caps">INTERVAL</span></span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_failed_request_ids</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># set by _get_sqs_dlq()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sqs_rcpts</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># set by _get_sqs_dlq()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; collect and report on all cloud-custodian Lambda errors &quot;&quot;&quot;</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="s1">&#39;Searching cloud-custodian Lambda functions for failed invocations&#39;</span>
        <span class="p">)</span>
        <span class="n">lambda_names</span> <span class="o">=</span> <span class="n">LambdaHealthChecker</span><span class="o">.</span><span class="n">find_matching_func_names</span><span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(custodian-|cloud-custodian-).*&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Custodian Lambda functions: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">lambda_names</span><span class="p">)</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_sqs_dlq</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> failed Lambda invocations: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed_request_ids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed_request_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">lambda_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_function</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;_check_function returned False (<span class="caps">NOT</span> <span class="caps">HEALTHY</span>) for: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">fname</span>
                <span class="p">)</span>
                <span class="n">errors</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Sleeping </span><span class="si">%s</span><span class="s1"> seconds before checking next function&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">INTER_FUNC_SLEEP</span>
            <span class="p">)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INTER_FUNC_SLEEP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ack_sqs</span><span class="p">()</span>
        <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed_request_ids</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed_request_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="n">red</span><span class="p">(</span><span class="s1">&#39;<span class="caps">ERROR</span>: </span><span class="si">%d</span><span class="s1"> failed Lambda RequestIDs could not be tied &#39;</span>
                    <span class="s1">&#39;to their function names: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">req_ids</span><span class="p">),</span> <span class="n">req_ids</span><span class="p">))</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Some lambda functions had errors in the last &#39;</span>
                  <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">INVL_DESC</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;No Lambda functions had errors in the last &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">INVL_DESC</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_sqs_dlq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pull all messages from the <span class="caps">SQS</span> Dead Letter Queue. Add the failed Lambda</span>
<span class="sd">        RequestIDs to `self._failed_request_ids` and the <span class="caps">SQS</span> Reciept Handles</span>
<span class="sd">        to `self._sqs_rcpts`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">msgs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Polling <span class="caps">SQS</span> queue: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlq_arn</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">msgs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqs</span><span class="o">.</span><span class="n">receive_message</span><span class="p">(</span>
                <span class="n">QueueUrl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dlq_arn</span><span class="p">,</span>
                <span class="n">WaitTimeSeconds</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                <span class="n">MaxNumberOfMessages</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">MessageAttributeNames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RequestID&#39;</span><span class="p">,</span> <span class="s1">&#39;ErrorMessage&#39;</span><span class="p">],</span>
                <span class="n">AttributeNames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;SentTimestamp&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">msgs</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Messages&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> <span class="caps">SQS</span> Messages received from one poll&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">msgs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_failed_request_ids</span><span class="p">[</span>
                    <span class="n">m</span><span class="p">[</span><span class="s1">&#39;MessageAttributes&#39;</span><span class="p">][</span><span class="s1">&#39;RequestID&#39;</span><span class="p">][</span><span class="s1">&#39;StringValue&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sqs_rcpts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;ReceiptHandle&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Received </span><span class="si">%d</span><span class="s1"> <span class="caps">SQS</span> messages in total&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;<span class="caps">SQS</span> Message Receipt Handles: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqs_rcpts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ack_sqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete (ack) all <span class="caps">SQS</span> messages in `self._sqs_rcpts`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">rh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqs_rcpts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sqs</span><span class="o">.</span><span class="n">delete_message</span><span class="p">(</span>
                <span class="n">QueueUrl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dlq_arn</span><span class="p">,</span>
                <span class="n">ReceiptHandle</span><span class="o">=</span><span class="n">rh</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check health of one Lambda function. Print information on it to <span class="caps">STDOUT</span>.</span>
<span class="sd">        Return True for healthy, False if errors/failures.</span>

<span class="sd">        :param func_name: Lambda function name to check</span>
<span class="sd">        :type func_name: str</span>
<span class="sd">        :return: whether the function had errors/failures</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">LambdaHealthChecker</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">logs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_logs</span><span class="p">,</span> <span class="n">cw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="p">)</span>
        <span class="n">req_ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed_request_ids</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed_request_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="p">]</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_filtered_logs</span><span class="p">(</span><span class="n">req_ids</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_cloudwatch_metric_sums</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Invocations&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">throttle_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Throttles&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Invocations&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">error_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Errors&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Invocations&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">throttle_pct</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">error_pct</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">error_pct</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Lambda Function Errors: </span><span class="si">%s%%</span><span class="s1"> (</span><span class="si">%d</span><span class="s1"> of </span><span class="si">%d</span><span class="s1"> invocations)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">error_pct</span><span class="p">,</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Errors&#39;</span><span class="p">],</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Invocations&#39;</span><span class="p">]</span>
            <span class="p">))</span>
        <span class="k">if</span> <span class="n">throttle_pct</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;Lambda Function Throttles: </span><span class="si">%s%%</span><span class="s1"> (</span><span class="si">%d</span><span class="s1"> of </span><span class="si">%d</span><span class="s1"> invocations)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">throttle_pct</span><span class="p">,</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Throttles&#39;</span><span class="p">],</span>
                    <span class="n">metrics</span><span class="p">[</span><span class="s1">&#39;Invocations&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">green</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: <span class="caps">OK</span></span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">func_name</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">print</span><span class="p">(</span><span class="n">red</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: <span class="caps">ERRORS</span>&#39;</span> <span class="o">%</span> <span class="n">func_name</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">red</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Logs For Failed Invocations:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">req_id</span> <span class="ow">in</span> <span class="n">logs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">events</span> <span class="o">=</span> <span class="n">logs</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_failed_request_ids</span><span class="p">[</span><span class="n">req_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">func_name</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">red</span><span class="p">(</span><span class="s1">&#39;RequestID=</span><span class="si">%s</span><span class="s1"> logGroupName=</span><span class="si">%s</span><span class="s1"> logStreamName=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">req_id</span><span class="p">,</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;logGroupName&#39;</span><span class="p">],</span> <span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;logStreamName&#39;</span><span class="p">]</span>
            <span class="p">)))</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
                <span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="k">def</span> <span class="nf">_name_value_dict</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list (``l``) containing dicts with ``Name`` and ``Value`` keys,</span>
<span class="sd">    return a single dict of Name -&gt; Value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="n">res</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">res</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Report on c7n lambda errors&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;verbose output. specify twice for debug-level output.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;DLQ_ARN&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                   <span class="n">help</span><span class="o">=</span><span class="s1">&#39;<span class="caps">ARN</span> to <span class="caps">SQS</span> Dead Letter Queue for all Lambda funcs&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">args</span>


<span class="k">def</span> <span class="nf">set_log_info</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;set logger level to <span class="caps">INFO</span>&quot;&quot;&quot;</span>
    <span class="n">set_log_level_format</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n"><span class="caps">INFO</span></span><span class="p">,</span>
                         <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">:</span><span class="si">%(name)s</span><span class="s1">:</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">set_log_debug</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;set logger level to <span class="caps">DEBUG</span>, and debug-level output format&quot;&quot;&quot;</span>
    <span class="n">set_log_level_format</span><span class="p">(</span>
        <span class="n">logging</span><span class="o">.</span><span class="n"><span class="caps">DEBUG</span></span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> [</span><span class="si">%(levelname)s</span><span class="s2"> </span><span class="si">%(filename)s</span><span class="s2">:</span><span class="si">%(lineno)s</span><span class="s2"> - &quot;</span>
        <span class="s2">&quot;</span><span class="si">%(name)s</span><span class="s2">.</span><span class="si">%(funcName)s</span><span class="s2">() ] </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">set_log_level_format</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">format</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set logger level and format.</span>

<span class="sd">    :param level: logging level; see the :py:mod:`logging` constants.</span>
<span class="sd">    :type level: int</span>
<span class="sd">    :param format: logging formatter format string</span>
<span class="sd">    :type format: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="n">format</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="c1"># set logging level</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">set_log_debug</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">set_log_info</span><span class="p">()</span>

    <span class="n">CustodianErrorReporter</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">DLQ_ARN</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
            </div>
            <!-- /.entry-content -->
    <hr />
    <!-- Shariff Button BEGIN -->
    <div class="shariff"
        data-lang="en"
        data-orientation="horizontal"
        data-services = "[&quot;facebook&quot;,&quot;googleplus&quot;,&quot;twitter&quot;,&quot;linkedin&quot;,&quot;diaspora&quot;]"
        data-theme="standard"
        data-url="https://blog.jasonantman.com/2017/10/cloud-custodian-architecture-deployment-and-policy-preprocessing/"></div>
    <!-- Shariff Button END -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jantman'; // required: replace example with your forum shortname

                    var disqus_identifier = 'cloud-custodian-architecture-deployment-and-policy-preprocessing';
                var disqus_url = 'https://blog.jasonantman.com/2017/10/cloud-custodian-architecture-deployment-and-policy-preprocessing/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="https://blog.jasonantman.com/2018/12/aws-reinvent-2018-my-experience-and-recommendations-for-next-time/"><span class="caps">AWS</span> re:Invent 2018: My Experience and Recommendations for Next&nbsp;Time</a></li>
    <li class="list-group-item"><a href="https://blog.jasonantman.com/2018/11/inexpensive-26USD-1080p-wifi-camera/">Inexpensive $<span class="caps">26USD</span> 1080p WiFi&nbsp;Camera</a></li>
    <li class="list-group-item"><a href="https://blog.jasonantman.com/2018/11/open-source-wifi-site-survey-tool/">Open Source WiFi Site Survey Heatmap&nbsp;Tool</a></li>
    <li class="list-group-item"><a href="https://blog.jasonantman.com/2018/08/home-automation-and-security-system-overview/">Home Automation and Security System&nbsp;Overview</a></li>
    <li class="list-group-item"><a href="https://blog.jasonantman.com/2018/07/better-logging-for-appdaemon-apps/">Better Logging for AppDaemon&nbsp;Apps</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Twitter Timeline -->
<li class="list-group-item">
  <h4><i class="fa fa-twitter fa-lg"></i><span class="icon-label">Latest Tweets</span></h4>
  <div id="twitter_timeline">
    <a class="twitter-timeline" data-width="250" data-height="300" data-dnt="true" data-theme="light" href="https://twitter.com/j_antman">Tweets by j_antman</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</li>
<!-- End Sidebar/Twitter Timeline -->

<!-- Sidebar/Github -->
<li class="list-group-item">
  <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
  <div id="gh_repos">
    <p class="list-group-item">Status updating...</p>
  </div>
  <a href="https://github.com/jantman">@jantman</a> on GitHub
</li>
<!-- End Sidebar/Github -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="http://www.jasonantman.com" target="_blank">Homepage</a>
    </li>
    <li class="list-group-item">
      <a href="http://resume.jasonantman.com" target="_blank">Resume</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Jason Antman
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.jasonantman.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.jasonantman.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.jasonantman.com/theme/js/respond.min.js"></script>



    <!-- GITHUB_REPOS_JSON (explicitly pinned repos ) -->
  <script id="GithubReposJson" type="application/json">
  [{"description": "A script and python module to check your AWS service limits and usage via boto.", "name": "awslimitchecker", "html_url": "https://github.com/jantman/awslimitchecker"}, {"description": "Puppet module and accompanying documentation to install/setup Arch linux on a MacBook Pro Retina 11,4", "name": "puppet-archlinux-macbookretina", "html_url": "https://github.com/jantman/puppet-archlinux-macbookretina"}, {"description": "A collection of my standalone scripts to small/quick for their own repos. All kinds of useful stuff.", "name": "misc-scripts", "html_url": "https://github.com/jantman/misc-scripts"}, {"description": "Responsive Flask/SQLAlchemy personal finance app, specifically for biweekly budgeting.", "name": "biweeklybudget", "html_url": "https://github.com/jantman/biweeklybudget"}, {"description": "A standard to easily communicate to humans and machines the development/support and usability status of software repositories/projects.", "name": "repostatus.org", "html_url": "https://github.com/jantman/repostatus.org"}, {"description": "Calculate detailed download stats and generate HTML and badges for PyPI packages", "name": "pypi-download-stats", "html_url": "https://github.com/jantman/pypi-download-stats"}]
  </script>

<!-- GitHub JS Code -->
<script type="text/javascript">
$(document).ready(function () {
  if (!window.jXHR) {
    var jxhr = document.createElement('script');
    jxhr.type = 'text/javascript';
    jxhr.src = 'https://blog.jasonantman.com/theme/js/jXHR.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(jxhr, s);
  }

  console.log($('#GithubReposJson').html());
  github.showSpecificRepos({
    user: 'jantman',
    target: '#gh_repos',
    repos: JSON.parse($('#GithubReposJson').html())
  });
});
</script>
<script src="https://blog.jasonantman.com/theme/js/github.js" type="text/javascript"></script>
<!-- End GitHub JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jantman'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-2718127-2', 'jasonantman.com');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->


    <!-- add shariff support -->
    <script src="https://blog.jasonantman.com/theme/js/shariff.min.js"></script>
</body>
</html>