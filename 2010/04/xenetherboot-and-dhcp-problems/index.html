<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Xen/Etherboot and DHCP Problems - Jason Antman's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://blog.jasonantman.com/2010/04/xenetherboot-and-dhcp-problems/">

        <meta name="author" content="admin" />
        <meta name="keywords" content="dhcp,dhcpd,etherboot,ldap,pxe,xen" />
        <meta name="description" content="Well, I’ve spend the better part of the last week or so debugging a problem with out new Xen VMs (on one host) not getting DHCP leases. Since our DHCP servers (ISC DHCPd 3.0.6) are using Brian Masney’s LDAP patch (which has recently been included in …" />

        <meta property="og:site_name" content="Jason Antman's Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Xen/Etherboot and DHCP Problems"/>
        <meta property="og:url" content="http://blog.jasonantman.com/2010/04/xenetherboot-and-dhcp-problems/"/>
        <meta property="og:description" content="Well, I’ve spend the better part of the last week or so debugging a problem with out new Xen VMs (on one host) not getting DHCP leases. Since our DHCP servers (ISC DHCPd 3.0.6) are using Brian Masney’s LDAP patch (which has recently been included in …"/>
        <meta property="article:published_time" content="2010-04-20" />
            <meta property="article:section" content="Tech HowTos" />
            <meta property="article:tag" content="dhcp" />
            <meta property="article:tag" content="dhcpd" />
            <meta property="article:tag" content="etherboot" />
            <meta property="article:tag" content="ldap" />
            <meta property="article:tag" content="pxe" />
            <meta property="article:tag" content="xen" />
            <meta property="article:author" content="admin" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="http://blog.jasonantman.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://blog.jasonantman.com/theme/css/pygments/default.css" rel="stylesheet">
        <link href="http://blog.jasonantman.com/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/style.css" type="text/css"/>
        <link href="http://blog.jasonantman.com/theme/css/shariff/shariff.min.css" rel="stylesheet">

    <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/forkongithub.min.css" type="text/css" />

        <link href="http://blog.jasonantman.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog ATOM Feed"/>

        <link href="http://blog.jasonantman.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Jason Antman's Blog RSS Feed"/>


        <link href="http://blog.jasonantman.com/feeds/categories/tech-howtos.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog Tech HowTos ATOM Feed"/>

    <script src="https://widget.battleforthenet.com/widget.js" async></script>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
<span id="forkongithub"><a href="https://github.com/jantman/blog">Fork me on GitHub</a></span>        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.jasonantman.com/" class="navbar-brand">
Jason Antman's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://blog.jasonantman.com/pages/about.html">
                             About
                          </a></li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/ideas-and-rants/index.html">Ideas and rants</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/miscellaneous/index.html">Miscellaneous</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/monitoring/index.html">Monitoring</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/ops/index.html">Ops</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/projects/index.html">Projects</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/puppet/index.html">Puppet</a>
                        </li>
                        <li class="active">
                            <a href="http://blog.jasonantman.com/categories/tech-howtos/index.html">Tech howtos</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://blog.jasonantman.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://blog.jasonantman.com/2010/04/xenetherboot-and-dhcp-problems/"
                       rel="bookmark"
                       title="Permalink to Xen/Etherboot and DHCP Problems">
                        Xen/Etherboot and <span class="caps">DHCP</span>&nbsp;Problems
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2010-04-20T10:46:00-04:00"> Tue 20 April 2010</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="http://blog.jasonantman.com/tags/dhcp/index.html">dhcp</a>
        /
	<a href="http://blog.jasonantman.com/tags/dhcpd/index.html">dhcpd</a>
        /
	<a href="http://blog.jasonantman.com/tags/etherboot/index.html">etherboot</a>
        /
	<a href="http://blog.jasonantman.com/tags/ldap/index.html">ldap</a>
        /
	<a href="http://blog.jasonantman.com/tags/pxe/index.html">pxe</a>
        /
	<a href="http://blog.jasonantman.com/tags/xen/index.html">xen</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Well, I&#8217;ve spend the better part of the last week or so debugging a
problem with out new Xen VMs (on one host) not getting <span class="caps">DHCP</span> leases.
Since our <span class="caps">DHCP</span> servers (<span class="caps">ISC</span> DHCPd 3.0.6) are using Brian Masney&#8217;s <a href="http://personal.cfw.com/~masneyb/"><span class="caps">LDAP</span>
patch</a> (which has recently been
included in <a href="http://www.isc.org/files/release-notes/42b2_0.html">mainline
DHCPd</a>), I assumed
that this might be the source of some of the&nbsp;problems.</p>
<p>The Xen client booting process uses <a href="http://etherboot.org/">Etherboot</a>
(specifically 5.4.2 on my machines) to get <span class="caps">DHCP</span> and <span class="caps">PXE</span> for the client.
The Etherboot <span class="caps">ROM</span> is generated online with
<a href="http://rom-o-matic.net/"><span class="caps">ROM</span>-o-Matic</a> (by the Xen devs) and is then
packaged into <code>hvmloader</code> (though I would not find this out until much
later in my investigation, given the piss-poor documentation about it).
So, aside from pulling the <span class="caps">SRPM</span> for Xen and looking around, I decided I
couldn&#8217;t really debug much on the client end (I wasn&#8217;t getting any
<span class="caps">BIOS</span>-like messages from Xen, so the client end seemed to be pretty much
a black&nbsp;box).</p>
<p>After a week of re-examining our <span class="caps">DHCP</span> servers, moving the client between
pieces of hardware and different networks, tracing out the <span class="caps">DHCP</span> logs,
and debugging everything in-between, I finally resorted to doing packet
captures and analyzing them. Last Thursday (my last work day of the
week), I popped my laptop on the same network, set it up in <span class="caps">DHCP</span>, and
did some captures of the laptop (which worked correctly) and the problem&nbsp;<span class="caps">VM</span>.</p>
<p>Sometime around 10:00 <span class="caps">PM</span>, long after I&#8217;d gotten home, I had opened
captures of both the good and bad hosts in separate
<a href="http://www.wireshark.org/">Wireshark</a> windows, and was going through
them line-by-line. I&#8217;d also written a nifty little <a href="/GFX/dhcptest.pl">Perl
script</a> (my weakest language) using
<a href="http://search.cpan.org/~fvandun/Net-DHCP-0.11/lib/Net/DHCP/Packet.pm">Net::<span class="caps">DHCP</span>::Packet</a>
to craft packets identical to the ones from the working and <span class="caps">FUBAR</span> hosts,
and inject them into the network. The only thing I could find different
was the value of the &#8220;secs&#8221; field of the <span class="caps">DHCPDISCOVER</span> packets (octets 9
and 10), which are supposed to contain the number of seconds that have
passed since the host started booting (<a href="http://www.faqs.org/rfcs/rfc1541.html"><span class="caps">RFC</span>
1541</a>). My laptop (the working
host) started getting replies from the server at 21 seconds. I took my
Perl packet-injecting script, and started adjusting the &#8220;secs&#8221; values of
both the working and bad packets. Sure enough, with identical packets
from each host, the values converged. Anything with &#8220;secs&#8221; below 2 got
no response from the <span class="caps">DHCP</span> server, anything with 2 or greater got a
correct&nbsp;lease.</p>
<p>Then it hit me. When we used to have a primary/secondary <span class="caps">DHCP</span> server
setup (with manual failover), we&#8217;d configured the secondary server with
<code>min-secs: 2</code>, instructing it to not give out any leases to clients with
a &#8220;secs&#8221; value of under 2, to prevent the secondary server from
answering if, for some reason, the primary was still online.&nbsp;Bingo.</p>
<p>At this point, I&#8217;m waiting to have a meeting of the binds before I add a
network-level override of &#8220;min-secs: 0&#8221; for the networks in question.
But I&#8217;m relatively confident that everything will go smoothly from there&nbsp;on.</p>
<p>This experience highlighted that one small &#8220;bug&#8221; can confuse 3 people
for the better part of a&nbsp;week:</p>
<p><a href="http://etherboot.org/">Etherboot</a> (at least 5.4.2) doesn&#8217;t increment
the &#8220;secs&#8221; field in its <span class="caps">DISCOVER</span> packets as <span class="caps">RFC</span> 1541 suggests. Therefore
anyone with &#8220;min-secs&#8221; in their dhcpd configuration won&#8217;t ever give out
a&nbsp;lease.</p>
<p>In hindsight, it really was a brain-dead moment. There was a little note
in the dhcpd logs that I, and the others, totally overlooked:
&#8220;<span class="caps">DHCPDISCOVER</span> (&#8230;) 0 secs &lt; 2&#8221;. I guess I should have turned my brain
on and realized that those few characters were probably important, and
there for a reason, no matter how unassuming (and un-error-like) they
may&nbsp;be&#8230;</p>
            </div>
            <!-- /.entry-content -->
    <hr />
    <!-- Shariff Button BEGIN -->
    <div class="shariff"
        data-lang="en"
        data-orientation="horizontal"
        data-services = "[&quot;facebook&quot;,&quot;googleplus&quot;,&quot;twitter&quot;,&quot;linkedin&quot;,&quot;diaspora&quot;]"
        data-theme="standard"
        data-url="http://blog.jasonantman.com/2010/04/xenetherboot-and-dhcp-problems/"></div>
    <!-- Shariff Button END -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jantman'; // required: replace example with your forum shortname

                    var disqus_identifier = 'xenetherboot-and-dhcp-problems';
                var disqus_url = 'http://blog.jasonantman.com/2010/04/xenetherboot-and-dhcp-problems/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="http://blog.jasonantman.com/2017/10/cloud-custodian-architecture-deployment-and-policy-preprocessing/">Cloud Custodian Architecture, Deployment and Policy&nbsp;Preprocessing</a></li>
    <li class="list-group-item"><a href="http://blog.jasonantman.com/2017/10/pre-authorized-aws-console-urls-for-notifications/">Pre-Authorized <span class="caps">AWS</span> Console URLs for&nbsp;Notifications</a></li>
    <li class="list-group-item"><a href="http://blog.jasonantman.com/2017/04/python-script-to-check-xfinity-data-usage/">Python script to check xfinity data&nbsp;usage</a></li>
    <li class="list-group-item"><a href="http://blog.jasonantman.com/2017/03/vyos-on-alix-2c1-single-board-computer/">VyOS on Alix 2C1 Single Board&nbsp;Computer</a></li>
    <li class="list-group-item"><a href="http://blog.jasonantman.com/2016/10/yesterdays-widespread-internet-outage-for-non-geeks/">Yesterday&#8217;s Widespread Internet Outage, for&nbsp;non-geeks</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Twitter Timeline -->
<li class="list-group-item">
  <h4><i class="fa fa-twitter fa-lg"></i><span class="icon-label">Latest Tweets</span></h4>
  <div id="twitter_timeline">
    <a class="twitter-timeline" data-width="250" data-height="300" data-dnt="true" data-theme="light" href="https://twitter.com/j_antman">Tweets by j_antman</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</li>
<!-- End Sidebar/Twitter Timeline -->

<!-- Sidebar/Github -->
<li class="list-group-item">
  <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
  <div id="gh_repos">
    <p class="list-group-item">Status updating...</p>
  </div>
  <a href="https://github.com/jantman">@jantman</a> on GitHub
</li>
<!-- End Sidebar/Github -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="http://www.jasonantman.com" target="_blank">Homepage</a>
    </li>
    <li class="list-group-item">
      <a href="http://resume.jasonantman.com" target="_blank">Resume</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Jason Antman
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://blog.jasonantman.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.jasonantman.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.jasonantman.com/theme/js/respond.min.js"></script>



    <!-- GITHUB_REPOS_JSON (explicitly pinned repos ) -->
  <script id="GithubReposJson" type="application/json">
  [{"description": "A script and python module to check your AWS service limits and usage via boto.", "name": "awslimitchecker", "html_url": "https://github.com/jantman/awslimitchecker"}, {"description": "Puppet module and accompanying documentation to install/setup Arch linux on a MacBook Pro Retina 11,4", "name": "puppet-archlinux-macbookretina", "html_url": "https://github.com/jantman/puppet-archlinux-macbookretina"}, {"description": "A collection of scripts that I've written", "name": "misc-scripts", "html_url": "https://github.com/jantman/misc-scripts"}, {"description": "Responsive Flask/SQLAlchemy personal finance app, specifically for biweekly budgeting.", "name": "biweeklybudget", "html_url": "https://github.com/jantman/biweeklybudget"}, {"description": "Calculate detailed download stats and generate HTML and badges for PyPI packages", "name": "pypi-download-stats", "html_url": "https://github.com/jantman/pypi-download-stats"}, {"description": "A standard to easily communicate to humans and machines the development/support and usability status of software repositories/projects.", "name": "repostatus.org", "html_url": "https://github.com/jantman/repostatus.org"}]
  </script>

<!-- GitHub JS Code -->
<script type="text/javascript">
$(document).ready(function () {
  if (!window.jXHR) {
    var jxhr = document.createElement('script');
    jxhr.type = 'text/javascript';
    jxhr.src = 'http://blog.jasonantman.com/theme/js/jXHR.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(jxhr, s);
  }

  console.log($('#GithubReposJson').html());
  github.showSpecificRepos({
    user: 'jantman',
    target: '#gh_repos',
    repos: JSON.parse($('#GithubReposJson').html())
  });
});
</script>
<script src="http://blog.jasonantman.com/theme/js/github.js" type="text/javascript"></script>
<!-- End GitHub JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jantman'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-2718127-2', 'jasonantman.com');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->


    <!-- add shariff support -->
    <script src="http://blog.jasonantman.com/theme/js/shariff.min.js"></script>
</body>
</html>