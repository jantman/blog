<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Nagios check_by_ssh and NAT - Jason Antman's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://blog.jasonantman.com/2009/10/nagios-check_by_ssh-and-nat/">

        <meta name="author" content="admin" />
        <meta name="keywords" content="monitoring,Nagios" />
        <meta name="description" content="At a remote location, I have a number of machines to monitor but only one IP (dynamic on a residential connection). Most of my remote monitoring with Nagios uses check_by_ssh. Previously, I’d used one host for Nagios to SSH to, and then chained together another check_by_ssh to reach the …" />

        <meta property="og:site_name" content="Jason Antman's Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Nagios check_by_ssh and NAT"/>
        <meta property="og:url" content="http://blog.jasonantman.com/2009/10/nagios-check_by_ssh-and-nat/"/>
        <meta property="og:description" content="At a remote location, I have a number of machines to monitor but only one IP (dynamic on a residential connection). Most of my remote monitoring with Nagios uses check_by_ssh. Previously, I’d used one host for Nagios to SSH to, and then chained together another check_by_ssh to reach the …"/>
        <meta property="article:published_time" content="2009-10-22" />
            <meta property="article:section" content="Monitoring" />
            <meta property="article:tag" content="monitoring" />
            <meta property="article:tag" content="Nagios" />
            <meta property="article:author" content="admin" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="http://blog.jasonantman.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://blog.jasonantman.com/theme/css/pygments/default.css" rel="stylesheet">
        <link href="http://blog.jasonantman.com/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/style.css" type="text/css"/>
        <link href="http://blog.jasonantman.com/theme/css/shariff/shariff.min.css" rel="stylesheet">

    <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/forkongithub.min.css" type="text/css" />

        <link href="http://blog.jasonantman.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog ATOM Feed"/>

        <link href="http://blog.jasonantman.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Jason Antman's Blog RSS Feed"/>


        <link href="http://blog.jasonantman.com/feeds/categories/monitoring.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog Monitoring ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
<span id="forkongithub"><a href="https://github.com/jantman/blog">Fork me on GitHub</a></span>        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.jasonantman.com/" class="navbar-brand">
Jason Antman's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://blog.jasonantman.com/pages/about.html">
                             About
                          </a></li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/ideas-and-rants/index.html">Ideas and rants</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/miscellaneous/index.html">Miscellaneous</a>
                        </li>
                        <li class="active">
                            <a href="http://blog.jasonantman.com/categories/monitoring/index.html">Monitoring</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/ops/index.html">Ops</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/projects/index.html">Projects</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/puppet/index.html">Puppet</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/tech-howtos/index.html">Tech howtos</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://blog.jasonantman.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://blog.jasonantman.com/2009/10/nagios-check_by_ssh-and-nat/"
                       rel="bookmark"
                       title="Permalink to Nagios check_by_ssh and NAT">
                        Nagios check_by_ssh and&nbsp;<span class="caps">NAT</span>
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2009-10-22T13:58:00-04:00"> Thu 22 October 2009</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="http://blog.jasonantman.com/tags/monitoring/index.html">monitoring</a>
        /
	<a href="http://blog.jasonantman.com/tags/nagios/index.html">Nagios</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>At a remote location, I have a number of machines to monitor but only
one <span class="caps">IP</span> (dynamic on a residential connection). Most of my remote
monitoring with Nagios uses check_by_ssh. Previously, I&#8217;d used one
host for Nagios to <span class="caps">SSH</span> to, and then chained together another
check_by_ssh to reach the remote hosts. Unfortunately, this means
nothing past the one first host can get monitored if the first host is
down. All of the other hosts (everything is behind <span class="caps">NAT</span>) have <span class="caps">SSH</span> visible
externally on different&nbsp;ports.</p>
<p><span class="caps">SSH</span> itself doesn&#8217;t like one <span class="caps">IP</span>/hostname with <span class="caps">SSH</span> on different ports -
host key verification will fail, as the <span class="caps">SSH</span> client only looks at the
address that it&#8217;s connecting to, not the port number. Normally, this is
bypassed by using a <code>.ssh/config</code> file&nbsp;like:</p>
<div class="highlight"><pre><span></span>Host foo1
        Hostname foo.example.com
        HostKeyAlias foo1
        CheckHostIP no
        Port 22
        User nagios

Host foo2
        Hostname foo.example.com
        HostKeyAlias foo2
        CheckHostIP no
        Port 222
        User nagios

Host foo3
        Hostname foo.example.com
        HostKeyAlias foo3
        CheckHostIP no
        Port 10022
        User nagios
</pre></div>


<p>And then you <span class="caps">SSH</span> using the &#8220;Host&#8221; named in the config file, not the
actual&nbsp;hostname.</p>
<p>Unfortunately, the only way to get check_by_ssh to do this was a bit
messy, and required defining a bunch of extra macros for each&nbsp;host:</p>
<div class="highlight"><pre><span></span>./check_by_ssh -o Hostname=foo.example.com -o HostKeyAlias=foo1 -o CheckHostIP=no -o Port=222 -o User=nagios -H foo.example.com -C uptime
</pre></div>


<p>So, I made a quick little patch for check_by_ssh.c (patched against
the released nagios-plugins-1.4.14)&nbsp;:</p>
<div class="highlight"><pre><span></span><span class="gd">--- check_by_ssh.c      2009-10-22 14:32:26.000000000 -0400</span>
<span class="gi">+++ check_by_ssh_ORIG.c 2009-10-22 14:12:15.000000000 -0400</span>
<span class="gu">@@ -181,7 +181,6 @@</span>
                {&quot;skip&quot;, optional_argument, 0, &#39;S&#39;}, /* backwards compatibility */
                {&quot;skip-stdout&quot;, optional_argument, 0, &#39;S&#39;},
                {&quot;skip-stderr&quot;, optional_argument, 0, &#39;E&#39;},
<span class="gd">-               {&quot;ssh-config&quot;, optional_argument, 0, &quot;F&quot;},</span>
                {&quot;proto1&quot;, no_argument, 0, &#39;1&#39;},
                {&quot;proto2&quot;, no_argument, 0, &#39;2&#39;},
                {&quot;use-ipv4&quot;, no_argument, 0, &#39;4&#39;},
<span class="gu">@@ -199,7 +198,7 @@</span>
                        strcpy (argv[c], &quot;-t&quot;);

        while (1) {
<span class="gd">-               c = getopt_long (argc, argv, &quot;Vvh1246fqt:H:O:p:i:u:l:C:S::E::n:s:o:F:&quot;, longopts,</span>
<span class="gi">+               c = getopt_long (argc, argv, &quot;Vvh1246fqt:H:O:p:i:u:l:C:S::E::n:s:o:&quot;, longopts,</span>
                                 &amp;option);

                if (c == -1 || c == <span class="caps">EOF</span>)
<span class="gu">@@ -222,7 +221,7 @@</span>
                                timeout_interval = atoi (optarg);
                        break;
                case &#39;H&#39;:                                                                       /* host */
<span class="gd">-                 /* host_or_die(optarg); */     /* commented out 2009-10-22 by jantman for ssh config file use */</span>
<span class="gi">+                       host_or_die(optarg);</span>
                        hostname = optarg;
                        break;
                case &#39;p&#39;: /* port number */
<span class="gu">@@ -300,12 +299,6 @@</span>
                        else
                                skip_stderr = atoi (optarg);
                        break;
<span class="gd">-               /* added 2009-10-22 by jantman for ssh -F option (config file) */</span>
<span class="gd">-               case &#39;F&#39;:                                                                       /* ssh config file */</span>
<span class="gd">-                       comm_append(&quot;-F&quot;);</span>
<span class="gd">-                       comm_append(optarg);</span>
<span class="gd">-                       break;</span>
<span class="gd">-               /* <span class="caps">END</span> added 2009-10-22 by jantman */</span>
                case &#39;o&#39;:                                                                       /* Extra options for the ssh command */
                        comm_append(&quot;-o&quot;);
                        comm_append(optarg);
<span class="gu">@@ -411,8 +404,6 @@</span>
   printf (&quot;    %s\n&quot;, _(&quot;Ignore all or (if specified) first n lines on <span class="caps">STDERR</span> [optional]&quot;));
   printf (&quot; %s\n&quot;, &quot;-f&quot;);
   printf (&quot;    %s\n&quot;, _(&quot;tells ssh to fork rather than create a tty [optional]. This will always return <span class="caps">OK</span> if ssh is executed&quot;));
<span class="gd">-  printf (&quot; %s\n&quot;, &quot;-F&quot;);</span>
<span class="gd">-  printf (&quot;    %s\n&quot;, _(&quot;path to ssh config file [optional]&quot;));</span>
   printf (&quot; %s\n&quot;,&quot;-C, --command=&#39;<span class="caps">COMMAND</span> <span class="caps">STRING</span>&#39;&quot;);
   printf (&quot;    %s\n&quot;, _(&quot;command to execute on the remote machine&quot;));
   printf (&quot; %s\n&quot;,&quot;-l, --logname=<span class="caps">USERNAME</span>&quot;);
</pre></div>


<p>It works fine. The only problem is that I disabled the check that the
given hostname/<span class="caps">IP</span> is valid, so instead of getting a nice &#8220;Invalid
hostname/address - foobar&#8221; error, you&#8217;ll get the usual &#8220;Remote command
execution failed: ssh: foobar: Name or service not known&#8221; error (though
it will still give an exit code of 3). I had to do this because
check_by_ssh was checking for a valid hostname itself, though <span class="caps">SSH</span>
needs to be passed the &#8220;Host&#8221; alias as defined in the config&nbsp;file.</p>
<p>With the patch, we now have something nice and clean&nbsp;like:</p>
<div class="highlight"><pre><span></span>./check_by_ssh -H foo1 -F /home/nagios/.ssh/config -l nagios -i /home/nagios/.ssh/id_dsa -C uptime
</pre></div>


<p>Which only adds the &#8220;-F&#8221; flag to what I was already using, and is safe
to use for all&nbsp;hosts.</p>
<p>When I get a chance, I&#8217;ll figure out a way to gracefully deal with the
host aliases (&#8220;fake hostnames&#8221;) and submit a patch. Most likely, I&#8217;ll
add another option so that you have to specify both the actual hostname
(so it can check that it exists) and the alias used in the config file
(perhaps&nbsp;&#8221;-a&#8221;?)</p>
            </div>
            <!-- /.entry-content -->
    <hr />
    <!-- Shariff Button BEGIN -->
    <div class="shariff"
        data-lang="en"
        data-orientation="horizontal"
        data-services = "[&quot;facebook&quot;,&quot;googleplus&quot;,&quot;twitter&quot;,&quot;linkedin&quot;,&quot;diaspora&quot;]"
        data-theme="standard"
        data-url="http://blog.jasonantman.com/2009/10/nagios-check_by_ssh-and-nat/"></div>
    <!-- Shariff Button END -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jantman'; // required: replace example with your forum shortname

                    var disqus_identifier = 'nagios-check_by_ssh-and-nat';
                var disqus_url = 'http://blog.jasonantman.com/2009/10/nagios-check_by_ssh-and-nat/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="http://blog.jasonantman.com/2017/04/python-script-to-check-xfinity-data-usage/">Python script to check xfinity data&nbsp;usage</a></li>
    <li class="list-group-item"><a href="http://blog.jasonantman.com/2017/03/vyos-on-alix-2c1-single-board-computer/">VyOS on Alix 2C1 Single Board&nbsp;Computer</a></li>
    <li class="list-group-item"><a href="http://blog.jasonantman.com/2016/10/yesterdays-widespread-internet-outage-for-non-geeks/">Yesterday&#8217;s Widespread Internet Outage, for&nbsp;non-geeks</a></li>
    <li class="list-group-item"><a href="http://blog.jasonantman.com/2016/08/openssh-changing-hostnames-based-on-location/">OpenSSH changing hostnames based on&nbsp;location</a></li>
    <li class="list-group-item"><a href="http://blog.jasonantman.com/2016/08/the-psychological-side-of-remote-work/">The Psychological Side of Remote&nbsp;Work</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Twitter Timeline -->
<li class="list-group-item">
  <h4><i class="fa fa-twitter fa-lg"></i><span class="icon-label">Latest Tweets</span></h4>
  <div id="twitter_timeline">
    <a class="twitter-timeline" data-width="250" data-height="300" data-dnt="true" data-theme="light" href="https://twitter.com/j_antman">Tweets by j_antman</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</li>
<!-- End Sidebar/Twitter Timeline -->

<!-- Sidebar/Github -->
<li class="list-group-item">
  <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
  <div id="gh_repos">
    <p class="list-group-item">Status updating...</p>
  </div>
  <a href="https://github.com/jantman">@jantman</a> on GitHub
</li>
<!-- End Sidebar/Github -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="http://www.jasonantman.com" target="_blank">Homepage</a>
    </li>
    <li class="list-group-item">
      <a href="http://resume.jasonantman.com" target="_blank">Resume</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Jason Antman
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://blog.jasonantman.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.jasonantman.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.jasonantman.com/theme/js/respond.min.js"></script>



    <!-- GITHUB_REPOS_JSON (explicitly pinned repos ) -->
  <script id="GithubReposJson" type="application/json">
  [{"description": "A script and python module to check your AWS service limits and usage via boto.", "name": "awslimitchecker", "html_url": "https://github.com/jantman/awslimitchecker"}, {"description": "Puppet module and accompanying documentation to install/setup Arch linux on a MacBook Pro Retina 11,4", "name": "puppet-archlinux-macbookretina", "html_url": "https://github.com/jantman/puppet-archlinux-macbookretina"}, {"description": "A collection of scripts that I've written", "name": "misc-scripts", "html_url": "https://github.com/jantman/misc-scripts"}, {"description": "Responsive Flask/SQLAlchemy personal finance app, specifically for biweekly budgeting.", "name": "biweeklybudget", "html_url": "https://github.com/jantman/biweeklybudget"}, {"description": "Calculate detailed download stats and generate HTML and badges for PyPI packages", "name": "pypi-download-stats", "html_url": "https://github.com/jantman/pypi-download-stats"}, {"description": "A standard to easily communicate to humans and machines the development/support and usability status of software repositories/projects.", "name": "repostatus.org", "html_url": "https://github.com/jantman/repostatus.org"}]
  </script>

<!-- GitHub JS Code -->
<script type="text/javascript">
$(document).ready(function () {
  if (!window.jXHR) {
    var jxhr = document.createElement('script');
    jxhr.type = 'text/javascript';
    jxhr.src = 'http://blog.jasonantman.com/theme/js/jXHR.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(jxhr, s);
  }

  console.log($('#GithubReposJson').html());
  github.showSpecificRepos({
    user: 'jantman',
    target: '#gh_repos',
    repos: JSON.parse($('#GithubReposJson').html())
  });
});
</script>
<script src="http://blog.jasonantman.com/theme/js/github.js" type="text/javascript"></script>
<!-- End GitHub JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jantman'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-2718127-2', 'jasonantman.com');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->


    <!-- add shariff support -->
    <script src="http://blog.jasonantman.com/theme/js/shariff.min.js"></script>
</body>
</html>