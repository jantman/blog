<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Terraform Shortcomings - No Interpolated Default Values, No Functions, No Conditionals, Local State Storage - Jason Antman's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://blog.jasonantman.com/2016/04/terraform-shortcomings-no-interpolated-default-values-no-functions/">

        <meta name="author" content="Jason Antman" />
        <meta name="keywords" content="terraform,hashicorp,AWS,go" />
        <meta name="description" content="some complaints about Terraform’s lack of functions and variable default values" />

        <meta property="og:site_name" content="Jason Antman's Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Terraform Shortcomings - No Interpolated Default Values, No Functions, No Conditionals, Local State Storage"/>
        <meta property="og:url" content="https://blog.jasonantman.com/2016/04/terraform-shortcomings-no-interpolated-default-values-no-functions/"/>
        <meta property="og:description" content="some complaints about Terraform’s lack of functions and variable default values"/>
        <meta property="article:published_time" content="2016-04-19" />
            <meta property="article:section" content="AWS" />
            <meta property="article:tag" content="terraform" />
            <meta property="article:tag" content="hashicorp" />
            <meta property="article:tag" content="AWS" />
            <meta property="article:tag" content="go" />
            <meta property="article:author" content="Jason Antman" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://blog.jasonantman.com/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="https://blog.jasonantman.com/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://blog.jasonantman.com/theme/css/pygments/default.css" rel="stylesheet">
        <link href="https://blog.jasonantman.com/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="https://blog.jasonantman.com/theme/css/style.css" type="text/css"/>
        <link href="https://blog.jasonantman.com/theme/css/shariff/shariff.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://blog.jasonantman.com/theme/css/forkongithub.min.css" type="text/css" />

        <link href="https://blog.jasonantman.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog ATOM Feed"/>

        <link href="https://blog.jasonantman.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
              title="Jason Antman's Blog RSS Feed"/>


        <link href="https://blog.jasonantman.com/feeds/categories/aws.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog AWS ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
<span id="forkongithub"><a href="https://github.com/jantman/blog">Fork me on GitHub</a></span>        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://blog.jasonantman.com/" class="navbar-brand">
Jason Antman's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                    <li><a href="/pages/about.html">About Me</a></li>
                    <li><a href="/categories/aws/index.html">AWS</a></li>
                    <li><a href="/categories/software/index.html">Software</a></li>
                    <li><a href="/categories/hardware/index.html">Hardware</a></li>
                    <li><a href="/categories/diy-home-automation-security/index.html">DIY / Home Automation / Security</a></li>
                    <li><a href="/categories/miscellaneous/index.html">Miscellaneous</a></li>
                    <li><a href="/tags.html">Tags</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="https://blog.jasonantman.com/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://blog.jasonantman.com/2016/04/terraform-shortcomings-no-interpolated-default-values-no-functions/"
                       rel="bookmark"
                       title="Permalink to Terraform Shortcomings - No Interpolated Default Values, No Functions, No Conditionals, Local State Storage">
                        Terraform Shortcomings - No Interpolated Default Values, No Functions, No Conditionals, Local State&nbsp;Storage
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-04-19T07:40:00-04:00"> Tue 19 April 2016</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://blog.jasonantman.com/tags/terraform/index.html">terraform</a>
        /
	<a href="https://blog.jasonantman.com/tags/hashicorp/index.html">hashicorp</a>
        /
	<a href="https://blog.jasonantman.com/tags/aws/index.html">AWS</a>
        /
	<a href="https://blog.jasonantman.com/tags/go/index.html">go</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Lately I&#8217;ve been using HashiCorp&#8217;s <a href="https://www.terraform.io/">Terraform</a> a lot to manage infrastructure. It certainly has some big things going for it; it supports a whole bunch of providers (including on-prem, non-cloud stuff like VMWare and Docker) as well as some database engines and <span class="caps">DNS</span> providers and can even manage GitHub teams, it can plan changes before committing them (which CloudFormation only <a href="https://aws.amazon.com/blogs/aws/new-change-sets-for-aws-cloudformation/">very recently</a> learned), and it can store the current state of your infrastructure in <a href="https://www.consul.io/">Consul</a>. Also a big step past CloudFormation, it has <a href="https://www.terraform.io/docs/provisioners/index.html">provisioners</a> including local execution, remote execution, file copying and Chef (strangely no built-in support for Puppet, but the remote-exec can do that) that can reach out to your newly-created instances and take actions on&nbsp;them.</p>
<p>Terraform also has a <a href="https://www.terraform.io/docs/providers/template/index.html">template provider</a> that&#8217;s used any time you need a templated file, such as <span class="caps">EC2</span> instance user-data or dynamically generated scripts to place on hosts. Terraform uses a <span class="caps">DSL</span> for its <a href="https://www.terraform.io/docs/configuration/index.html">configuration</a>, either the <span class="caps">JSON</span>-like but slightly-more-human-readable <a href="https://github.com/hashicorp/hcl">Hashicorp Configuration Language (<span class="caps">HCL</span>)</a> or the same information conveyed in pure <span class="caps">JSON</span>. The configuration language supports variables (passed in at the command line or in a file) and is based on <a href="https://www.terraform.io/docs/configuration/interpolation.html">string interpolation</a> with a handful of functions defined. It&#8217;s also worth noting that Terraform is written in Go; it has a <a href="https://www.terraform.io/docs/plugins/index.html">plugin system</a> but only for Providers and Provisioners; there&#8217;s no way to add core functionality (I suppose I&#8217;ve been spolied by Puppet having such good support for adding core functionality via Ruby, or HashiCorp&#8217;s Vagrant having a config file that itself is&nbsp;Ruby).</p>
<p>Now that I&#8217;ve been nice and said some great things about Terraform (and it really is; at least for the way my current job is managing infrastructure, I&#8217;ve fallen in love with it, and it certainly does fix some shortcomings that I found in CloudFormation, specifically with pre-execution plans and ability to interact with resources), on to my complaints of the&nbsp;day.</p>
<h2 id="local-state-storage"><a class="toclink" href="#local-state-storage">Local State&nbsp;Storage</a></h2>
<p>My first complaint is that by default, Terraform stores the state of your infrastrucutre in a file in your current working directory. It uses this to attempt to figure out the already-existing resources you&#8217;ve created, and only make the required changes. The first time I used terraform, I completely destroyed one of our (luckily non-production) services; coworkers of mine have brought down production services because of&nbsp;this.</p>
<p>Let&#8217;s say that we have a Terraform configuration which takes one variable, <code>environment</code>. That variable determines the <span class="caps">VPC</span> and subnets we deploy into, our <span class="caps">DNS</span> names, and also gets passed to <span class="caps">EC2</span> instances via user-data. We build our infrastructure with <code>environment = "prod"</code>, and everything works right - we now have a production cluster of our service. Then we want to test some changes, so we run again with <code>environment = "dev"</code>. The naive - and logical - assumption would be that we get a second &#8220;dev&#8221; cluster of our service. Nope. Terraform finds the <code>terraform.tfstate</code> file in our current directory, reads it, and takes it to be the current state of our infrastructure. It sees that we <strong>changed</strong> <code>environment</code> from &#8220;prod&#8221; to &#8220;dev&#8221;&#8230; so it destroys our <span class="caps">EC2</span> instances and <span class="caps">DNS</span> record, and creates new ones for &#8220;dev&#8221; (applying the requested&nbsp;changes).</p>
<p>This teaches us two important&nbsp;points:</p>
<ol>
<li><strong>Always</strong> run <code>terraform plan</code>. Even if you think your changes are trivial, examine what Terraform will do before running <code>apply</code>.</li>
<li><strong>Always</strong> run <code>terraform</code> through a wrapper. We have a simple Rake task in an internal rubygem that ensures that Terraform will always store state in Consul, so it won&#8217;t be locked to one person&#8217;s local machine, and also removes any local state files before running so they won&#8217;t pollute the run or result in changes intended for one isolated instance of our Terraform configuration from being applied to&nbsp;another.</li>
</ol>
<h2 id="functions"><a class="toclink" href="#functions">Functions</a></h2>
<p>Terraform&#8217;s <a href="https://www.terraform.io/docs/configuration/interpolation.html">configuration interpolation</a> has a bunch of built-in functions for working with variables. They&#8217;re a subset of what you&#8217;d expect in a language that is mainly based around strings, arrays and maps/hashes: split, join, concat, lookup (get a hash item by key), index (find the index of an item in a list), element (return the n&#8217;th element of a list), format (sprintf-like), etc. However, there&#8217;s no function to retrieve only unique elements from a list. This becomes a problem especially when dealing with multi-<span class="caps">AZ</span>/multi-subnet <span class="caps">AWS</span> resources, as some of them (e.g. managing a set number individual <span class="caps">EC2</span> instances outside of an <span class="caps">ASG</span>, such as when assigning static IPs) require a list of subnets matching the number of resources, and others (cross-<span class="caps">AZ</span> ELBs) require a list of unique&nbsp;subnets.</p>
<p>Terraform and its language have no way to add this functionality (<em>see note below</em>); the only option that I&#8217;ve found is to wrap Terraform in some sort of runner (I use <a href="https://github.com/ruby/rake">Rake</a> but you could use any scripting or Make-like language) that does whatever manipulation and calculation is needed, and passes in the necessary values distinct variable values (i.e. the full subnet list, and the unique subnet list, as separate variables). To make this even more difficult, though Terraform supports loading built-time variables from a <span class="caps">JSON</span> or <span class="caps">HCL</span> file instead of the command line, it only supports taking in variables as strings (even in <span class="caps">JSON</span>). So in our subnet example, our wrapper script needs to join the list of subnets into a string (i.e. <span class="caps">CSV</span>) and then whenever we use the variable in Terraform, we need to <code>split()</code> it on our separator character (because Terraform doesn&#8217;t support variable setting or&nbsp;manipulation).</p>
<p><em><span class="dquo">&#8220;</span>Terraform [has] no way to add this functionality&#8221;</em> - I&#8217;m aware that I could fork Terraform, learn Go, and submit pull requests for all of the features I think would be useful; and if I had maybe half a dozen less unfinished projects, I&#8217;d probably do that. However, this still means that HashiCorp would need to accept and merge my PRs and release a new version, or else I&#8217;d need to build and distribute my forked version. Terraform supports <a href="https://www.terraform.io/docs/plugins/index.html">plugins</a>, but only for Providers and Provisioners, not language internals. What I&#8217;d really like is a way to define plugin functions that could be distributed without having to rebuild all of&nbsp;Terraform.</p>
<h2 id="no-interpolated-default-variable-values"><a class="toclink" href="#no-interpolated-default-variable-values">No Interpolated Default Variable&nbsp;Values</a></h2>
<p>Terraform variables can have default values defined for them. However, these default values have no way of using other variables. This means that even for relatively common use cases - like a service that has a name and a <span class="caps">DNS</span> record, both of which can be overridden but with the <span class="caps">DNS</span> record defaulting to &#8220;SERVICE_NAME.example.com&#8221;, you can&#8217;t do that. The only options that I&#8217;ve been able to figure out are to either do it in your wrapper script (which means the Terraform configs can&#8217;t be run without the wrapper) or use the <code>coalesce</code> function to give your variable an empty default value, and then choose a second interpolated string if the variable is&nbsp;empty.</p>
<h2 id="no-conditionals"><a class="toclink" href="#no-conditionals">No&nbsp;Conditionals</a></h2>
<p>Terraform&#8217;s configuration language also lacks conditional statements such as <code>if</code>. This poses a problem with all but the simplest applications, and is certainly likely to be an issue for anyone who wants to do the right thing and use the same tooling to deploy multiple environments. It seems that the only options are to either pass in the necessary information as variables from a wrapper script, or generate Terraform configurations with other tooling. The former works only if the desired result is a variable in your configuration; there&#8217;s simply no way that I&#8217;ve found to have a conditional around resource(s). The only obvious option for that is to take advantage of Terraform&#8217;s ability to read configurations as <span class="caps">JSON</span>, and simply generate your entire terraform configuration with another&nbsp;tool.</p>
            </div>
            <!-- /.entry-content -->
    <hr />
    <!-- Shariff Button BEGIN -->
    <div class="shariff"
        data-lang="en"
        data-orientation="horizontal"
        data-services = "[&quot;facebook&quot;,&quot;googleplus&quot;,&quot;twitter&quot;,&quot;linkedin&quot;,&quot;diaspora&quot;]"
        data-theme="standard"
        data-url="https://blog.jasonantman.com/2016/04/terraform-shortcomings-no-interpolated-default-values-no-functions/"></div>
    <!-- Shariff Button END -->
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jantman'; // required: replace example with your forum shortname

                    var disqus_identifier = 'terraform-shortcomings-no-interpolated-default-values-no-functions';
                var disqus_url = 'https://blog.jasonantman.com/2016/04/terraform-shortcomings-no-interpolated-default-values-no-functions/';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="https://blog.jasonantman.com/2021/03/octoprint-power-outage-handling/">OctoPrint Power Outage&nbsp;Handling</a></li>
    <li class="list-group-item"><a href="https://blog.jasonantman.com/2020/11/on-the-creation-use-and-management-of-docker-images/">On The Creation, Use, and Management of Docker&nbsp;Images</a></li>
    <li class="list-group-item"><a href="https://blog.jasonantman.com/2019/04/galaxy-s10--android-9-alarm-app-broken-by-battery-optimization/">Galaxy S10 / Android 9 alarm app broken by battery&nbsp;optimization</a></li>
    <li class="list-group-item"><a href="https://blog.jasonantman.com/2019/03/arch-linux-on-a-dell-precision-5530--xps-15-9570-laptop/">Arch Linux on a Dell Precision 5530 / <span class="caps">XPS</span> 15 9570&nbsp;Laptop</a></li>
    <li class="list-group-item"><a href="https://blog.jasonantman.com/2018/12/twilio-programmable-wireless-ppp-proxy-docker-image/">Twilio Programmable Wireless <span class="caps">PPP</span> Proxy Docker&nbsp;Image</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Twitter Timeline -->
<li class="list-group-item">
  <h4><i class="fa fa-twitter fa-lg"></i><span class="icon-label">Latest Tweets</span></h4>
  <div id="twitter_timeline">
    <a class="twitter-timeline" data-width="250" data-height="300" data-dnt="true" data-theme="light" href="https://twitter.com/j_antman">Tweets by j_antman</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</li>
<!-- End Sidebar/Twitter Timeline -->

<!-- Sidebar/Github -->
<li class="list-group-item">
  <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
  <div id="gh_repos">
    <p class="list-group-item">Status updating...</p>
  </div>
  <a href="https://github.com/jantman">@jantman</a> on GitHub
</li>
<!-- End Sidebar/Github -->

<!-- Sidebar/Links -->
<li class="list-group-item">
  <h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
  <ul class="list-group" id="links">
    <li class="list-group-item">
      <a href="http://www.jasonantman.com" target="_blank">Homepage</a>
    </li>
    <li class="list-group-item">
      <a href="http://resume.jasonantman.com" target="_blank">Resume</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Links -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2021 Jason Antman
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://blog.jasonantman.com/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://blog.jasonantman.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://blog.jasonantman.com/theme/js/respond.min.js"></script>



    <!-- GITHUB_REPOS_JSON (explicitly pinned repos ) -->
  <script id="GithubReposJson" type="application/json">
  [{"description": "A script and python package to check your AWS service limits and usage via boto3.", "name": "awslimitchecker", "html_url": "https://github.com/jantman/awslimitchecker"}, {"description": "A collection of my standalone scripts to small/quick for their own repos. All kinds of useful stuff.", "name": "misc-scripts", "html_url": "https://github.com/jantman/misc-scripts"}, {"description": "Responsive Flask/SQLAlchemy personal finance app, specifically for biweekly budgeting.", "name": "biweeklybudget", "html_url": "https://github.com/jantman/biweeklybudget"}, {"description": "A standard to easily communicate to humans and machines the development/support and usability status of software repositories/projects.", "name": "repostatus.org", "html_url": "https://github.com/jantman/repostatus.org"}, {"description": "home automation/security config/scripts/tooling - HomeAssistant, AppDaemon, ZoneMinder, etc.", "name": "home-automation-configs", "html_url": "https://github.com/jantman/home-automation-configs"}, {"description": "A Python application for Linux machines to perform WiFi site surveys and present the results as a heatmap overlayed on a floorplan", "name": "python-wifi-survey-heatmap", "html_url": "https://github.com/jantman/python-wifi-survey-heatmap"}]
  </script>

<!-- GitHub JS Code -->
<script type="text/javascript">
$(document).ready(function () {
  if (!window.jXHR) {
    var jxhr = document.createElement('script');
    jxhr.type = 'text/javascript';
    jxhr.src = 'https://blog.jasonantman.com/theme/js/jXHR.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(jxhr, s);
  }

  console.log($('#GithubReposJson').html());
  github.showSpecificRepos({
    user: 'jantman',
    target: '#gh_repos',
    repos: JSON.parse($('#GithubReposJson').html())
  });
});
</script>
<script src="https://blog.jasonantman.com/theme/js/github.js" type="text/javascript"></script>
<!-- End GitHub JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jantman'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics Universal -->
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-2718127-2', 'jasonantman.com');
        ga('send', 'pageview');
    </script>
    <!-- End Google Analytics Universal Code -->


    <!-- add shariff support -->
    <script src="https://blog.jasonantman.com/theme/js/shariff.min.js"></script>
</body>
</html>